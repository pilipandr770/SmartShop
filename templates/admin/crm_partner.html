{% extends "admin/layout.html" %}

{% block title %}–ü–∞—Ä—Ç–Ω–µ—Ä: {{ company.name }}{% endblock %}

{% block content %}
<div class="partner-detail-page">
    <div class="page-header">
        <div class="breadcrumb">
            <a href="{{ url_for('admin_crm') }}">‚Üê CRM</a>
        </div>
        <h1>üè¢ {{ company.name }}</h1>
        <span class="status-badge {{ company.status }}">{{ company.status }}</span>
    </div>
    
    <!-- Alerts for this company -->
    {% if company_alerts %}
    <div class="company-alerts">
        <h3>‚ö†Ô∏è –ê–∫—Ç–∏–≤–Ω—ñ –∞–ª–µ—Ä—Ç–∏</h3>
        {% for alert in company_alerts %}
        <div class="alert-item {{ alert.severity }}">
            <div class="alert-content">
                <strong>{{ alert.title }}</strong>
                <p>{{ alert.message }}</p>
                <small>{{ alert.created_at.strftime('%d.%m.%Y %H:%M') }}</small>
            </div>
            <button class="btn btn-sm" onclick="resolveAlert({{ alert.id }})">–í–∏—Ä—ñ—à–µ–Ω–æ</button>
        </div>
        {% endfor %}
    </div>
    {% endif %}
    
    <div class="content-grid">
        <!-- Main Info -->
        <div class="info-card">
            <h3>üìã –û—Å–Ω–æ–≤–Ω–∞ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è</h3>
            <table class="info-table">
                <tr>
                    <td>–Æ—Ä–∏–¥–∏—á–Ω–∞ –Ω–∞–∑–≤–∞</td>
                    <td>{{ company.legal_name or company.name }}</td>
                </tr>
                <tr>
                    <td>VAT –Ω–æ–º–µ—Ä</td>
                    <td>
                        {% if company.vat_number %}
                        <code>{{ company.full_vat_number }}</code>
                        {% if company.vat_verified %}
                        <span class="badge success">‚úì –ü–µ—Ä–µ–≤—ñ—Ä–µ–Ω–æ</span>
                        {% else %}
                        <span class="badge warning">–ù–µ –ø–µ—Ä–µ–≤—ñ—Ä–µ–Ω–æ</span>
                        {% endif %}
                        {% else %}
                        <span class="na">–ù–µ –≤–∫–∞–∑–∞–Ω–æ</span>
                        {% endif %}
                    </td>
                </tr>
                <tr>
                    <td>Handelsregister</td>
                    <td>
                        {% if company.handelsregister_id %}
                        <code>{{ company.handelsregister_id }}</code>
                        {% if company.is_hr_verified %}
                        <span class="badge success">‚úì</span>
                        {% endif %}
                        {% else %}
                        <span class="na">-</span>
                        {% endif %}
                    </td>
                </tr>
                <tr>
                    <td>–í–µ–±-—Å–∞–π—Ç</td>
                    <td>
                        {% if company.website %}
                        <a href="{{ company.website }}" target="_blank">{{ company.website }}</a>
                        {% if company.is_whois_verified %}
                        <span class="badge success">‚úì</span>
                        {% endif %}
                        {% else %}
                        <span class="na">-</span>
                        {% endif %}
                    </td>
                </tr>
                <tr>
                    <td>–ê–¥—Ä–µ—Å–∞</td>
                    <td>{{ company.full_address or '-' }}</td>
                </tr>
                <tr>
                    <td>–ö—Ä–∞—ó–Ω–∞</td>
                    <td>{{ company.country }} ({{ company.country_code }})</td>
                </tr>
            </table>
        </div>
        
        <!-- Reliability Score -->
        <div class="info-card reliability-card {{ company.reliability_level }}">
            <h3>üìä –ù–∞–¥—ñ–π–Ω—ñ—Å—Ç—å –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç–∞</h3>
            <div class="score-display">
                <div class="score-circle">
                    <svg viewBox="0 0 100 100">
                        <circle cx="50" cy="50" r="45" fill="none" stroke="#e9ecef" stroke-width="8"/>
                        <circle cx="50" cy="50" r="45" fill="none" stroke="currentColor" stroke-width="8"
                                stroke-dasharray="{{ company.reliability_score * 2.83 }} 283"
                                stroke-linecap="round" transform="rotate(-90 50 50)"/>
                    </svg>
                    <span class="score-value">{{ company.reliability_score }}</span>
                </div>
                <div class="score-label">
                    {% if company.reliability_level == 'high' %}
                    ‚úÖ –í–∏—Å–æ–∫–∏–π —Ä—ñ–≤–µ–Ω—å –Ω–∞–¥—ñ–π–Ω–æ—Å—Ç—ñ
                    {% elif company.reliability_level == 'medium' %}
                    ‚ö†Ô∏è –°–µ—Ä–µ–¥–Ω—ñ–π —Ä—ñ–≤–µ–Ω—å –Ω–∞–¥—ñ–π–Ω–æ—Å—Ç—ñ
                    {% elif company.reliability_level == 'low' %}
                    üî∂ –ù–∏–∑—å–∫–∏–π —Ä—ñ–≤–µ–Ω—å –Ω–∞–¥—ñ–π–Ω–æ—Å—Ç—ñ
                    {% else %}
                    ‚ùå –ö—Ä–∏—Ç–∏—á–Ω–∏–π —Ä—ñ–≤–µ–Ω—å
                    {% endif %}
                </div>
            </div>
            
            <div class="verification-checks">
                <div class="check {% if company.vat_verified %}passed{% else %}pending{% endif %}">
                    <span class="icon">{% if company.vat_verified %}‚úÖ{% else %}‚è≥{% endif %}</span>
                    <span class="label">VAT/VIES</span>
                </div>
                <div class="check {% if company.is_whois_verified %}passed{% else %}pending{% endif %}">
                    <span class="icon">{% if company.is_whois_verified %}‚úÖ{% else %}‚è≥{% endif %}</span>
                    <span class="label">WHOIS</span>
                </div>
                {% if company.country_code == 'DE' %}
                <div class="check {% if company.is_hr_verified %}passed{% else %}pending{% endif %}">
                    <span class="icon">{% if company.is_hr_verified %}‚úÖ{% else %}‚è≥{% endif %}</span>
                    <span class="label">Handelsregister</span>
                </div>
                {% endif %}
            </div>
            
            <button class="btn btn-primary btn-block" onclick="verifyPartner({{ company.id }})">
                üîç –ó–∞–ø—É—Å—Ç–∏—Ç–∏ –ø–µ—Ä–µ–≤—ñ—Ä–∫—É
            </button>
        </div>
        
        <!-- Contact Info -->
        <div class="info-card">
            <h3>üìû –ö–æ–Ω—Ç–∞–∫—Ç–Ω–∞ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è</h3>
            <table class="info-table">
                <tr>
                    <td>–ö–æ–Ω—Ç–∞–∫—Ç–Ω–∞ –æ—Å–æ–±–∞</td>
                    <td>{{ company.contact_person or '-' }}</td>
                </tr>
                <tr>
                    <td>Email</td>
                    <td>
                        {% if company.contact_email %}
                        <a href="mailto:{{ company.contact_email }}">{{ company.contact_email }}</a>
                        {% else %}-{% endif %}
                    </td>
                </tr>
                <tr>
                    <td>–¢–µ–ª–µ—Ñ–æ–Ω</td>
                    <td>{{ company.contact_phone or '-' }}</td>
                </tr>
            </table>
        </div>
        
        <!-- B2B Settings -->
        <div class="info-card">
            <h3>üí∞ B2B –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è</h3>
            <form method="post" action="{{ url_for('admin_crm_partner_update', id=company.id) }}">
                <div class="form-group">
                    <label>–ö—Ä–µ–¥–∏—Ç–Ω–∏–π –ª—ñ–º—ñ—Ç (‚Ç¨)</label>
                    <input type="number" name="credit_limit" value="{{ company.credit_limit }}" step="0.01">
                </div>
                <div class="form-group">
                    <label>–¢–µ—Ä–º—ñ–Ω–∏ –æ–ø–ª–∞—Ç–∏ (–¥–Ω—ñ–≤)</label>
                    <select name="payment_terms">
                        <option value="0" {% if company.payment_terms == 0 %}selected{% endif %}>–ü–µ—Ä–µ–¥–æ–ø–ª–∞—Ç–∞</option>
                        <option value="7" {% if company.payment_terms == 7 %}selected{% endif %}>7 –¥–Ω—ñ–≤</option>
                        <option value="14" {% if company.payment_terms == 14 %}selected{% endif %}>14 –¥–Ω—ñ–≤</option>
                        <option value="30" {% if company.payment_terms == 30 %}selected{% endif %}>30 –¥–Ω—ñ–≤</option>
                        <option value="60" {% if company.payment_terms == 60 %}selected{% endif %}>60 –¥–Ω—ñ–≤</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>–ó–Ω–∏–∂–∫–∞ (%)</label>
                    <input type="number" name="discount_percent" value="{{ company.discount_percent }}" step="0.1" min="0" max="50">
                </div>
                <button type="submit" class="btn btn-primary">–ó–±–µ—Ä–µ–≥—Ç–∏</button>
            </form>
        </div>
    </div>
    
    <!-- Last Verification Data -->
    {% if company.last_verification_data %}
    <div class="verification-details">
        <h3>üìã –†–µ–∑—É–ª—å—Ç–∞—Ç–∏ –æ—Å—Ç–∞–Ω–Ω—å–æ—ó –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏</h3>
        <div class="details-grid">
            {% if company.last_verification_data.vat_result %}
            <div class="detail-card">
                <h4>VAT/VIES</h4>
                <pre>{{ company.last_verification_data.vat_result | tojson(indent=2) }}</pre>
            </div>
            {% endif %}
            
            {% if company.last_verification_data.whois_result %}
            <div class="detail-card">
                <h4>WHOIS</h4>
                <pre>{{ company.last_verification_data.whois_result | tojson(indent=2) }}</pre>
            </div>
            {% endif %}
            
            {% if company.last_verification_data.hr_result %}
            <div class="detail-card">
                <h4>Handelsregister</h4>
                <pre>{{ company.last_verification_data.hr_result | tojson(indent=2) }}</pre>
            </div>
            {% endif %}
        </div>
    </div>
    {% endif %}
    
    <!-- Verification Logs -->
    <div class="verification-logs">
        <h3>üìú –Ü—Å—Ç–æ—Ä—ñ—è –ø–µ—Ä–µ–≤—ñ—Ä–æ–∫</h3>
        <table class="logs-table">
            <thead>
                <tr>
                    <th>–î–∞—Ç–∞</th>
                    <th>–¢–∏–ø</th>
                    <th>–†–µ–∑—É–ª—å—Ç–∞—Ç</th>
                    <th>–ó–º—ñ–Ω–∏</th>
                    <th>–î–µ—Ç–∞–ª—ñ</th>
                </tr>
            </thead>
            <tbody>
                {% for log in verification_logs %}
                <tr>
                    <td>{{ log.checked_at.strftime('%d.%m.%Y %H:%M') }}</td>
                    <td>
                        <span class="log-type">{{ log.check_type }}</span>
                    </td>
                    <td>
                        {% if log.is_valid %}
                        <span class="badge success">‚úì –£—Å–ø—ñ—à–Ω–æ</span>
                        {% else %}
                        <span class="badge danger">‚úó –ü–æ–º–∏–ª–∫–∞</span>
                        {% endif %}
                    </td>
                    <td>
                        {% if log.changes_detected %}
                        <span class="badge warning">‚ö†Ô∏è –ó–º—ñ–Ω–∏!</span>
                        <small>{{ log.changes_description }}</small>
                        {% else %}
                        <span class="na">-</span>
                        {% endif %}
                    </td>
                    <td>
                        <button class="btn btn-sm" onclick="showLogDetails({{ log.id }})">üëÅÔ∏è</button>
                    </td>
                </tr>
                {% endfor %}
                {% if not logs %}
                <tr>
                    <td colspan="5" class="empty">–ù–µ–º–∞—î –∑–∞–ø–∏—Å—ñ–≤</td>
                </tr>
                {% endif %}
            </tbody>
        </table>
    </div>
    
    <!-- Actions -->
    <div class="page-actions">
        {% if company.status == 'pending' %}
        <button class="btn btn-success" onclick="approvePartner({{ company.id }})">
            ‚úÖ –ü—ñ–¥—Ç–≤–µ—Ä–¥–∏—Ç–∏ –ø–∞—Ä—Ç–Ω–µ—Ä–∞
        </button>
        <button class="btn btn-danger" onclick="rejectPartner({{ company.id }})">
            ‚ùå –í—ñ–¥—Ö–∏–ª–∏—Ç–∏
        </button>
        {% elif company.status == 'verified' %}
        <button class="btn btn-warning" onclick="suspendPartner({{ company.id }})">
            üö´ –ü—Ä–∏–∑—É–ø–∏–Ω–∏—Ç–∏
        </button>
        {% elif company.status == 'suspended' %}
        <button class="btn btn-success" onclick="approvePartner({{ company.id }})">
            ‚úÖ –í—ñ–¥–Ω–æ–≤–∏—Ç–∏
        </button>
        {% endif %}
    </div>
</div>

<style>
.partner-detail-page { padding: 20px; max-width: 1400px; margin: 0 auto; }

.page-header {
    display: flex;
    align-items: center;
    gap: 20px;
    margin-bottom: 30px;
}
.page-header h1 { margin: 0; flex: 1; }
.breadcrumb a { color: #666; text-decoration: none; }
.breadcrumb a:hover { color: #007bff; }

.company-alerts {
    background: #fff3cd;
    border: 1px solid #ffc107;
    border-radius: 12px;
    padding: 20px;
    margin-bottom: 30px;
}
.company-alerts h3 { margin-top: 0; }
.alert-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 15px;
    background: white;
    border-radius: 8px;
    margin-bottom: 10px;
    border-left: 4px solid #ffc107;
}
.alert-item.critical { border-left-color: #dc3545; }
.alert-item.warning { border-left-color: #ffc107; }
.alert-content p { margin: 5px 0; }
.alert-content small { color: #666; }

.content-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
}

.info-card {
    background: white;
    border-radius: 12px;
    padding: 20px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}
.info-card h3 {
    margin: 0 0 20px 0;
    padding-bottom: 10px;
    border-bottom: 1px solid #eee;
}

.info-table { width: 100%; }
.info-table td { padding: 10px 0; border-bottom: 1px solid #f5f5f5; }
.info-table td:first-child { color: #666; width: 40%; }

.reliability-card.high { border-top: 4px solid #28a745; }
.reliability-card.medium { border-top: 4px solid #ffc107; }
.reliability-card.low { border-top: 4px solid #fd7e14; }
.reliability-card.critical { border-top: 4px solid #dc3545; }

.score-display {
    display: flex;
    flex-direction: column;
    align-items: center;
    margin-bottom: 20px;
}
.score-circle {
    position: relative;
    width: 120px;
    height: 120px;
}
.score-circle svg {
    width: 100%;
    height: 100%;
}
.reliability-card.high .score-circle svg circle:last-child { stroke: #28a745; }
.reliability-card.medium .score-circle svg circle:last-child { stroke: #ffc107; }
.reliability-card.low .score-circle svg circle:last-child { stroke: #fd7e14; }
.reliability-card.critical .score-circle svg circle:last-child { stroke: #dc3545; }

.score-circle .score-value {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    font-size: 32px;
    font-weight: bold;
}
.score-label {
    margin-top: 10px;
    font-weight: 500;
}

.verification-checks {
    display: flex;
    justify-content: center;
    gap: 15px;
    margin-bottom: 20px;
}
.check {
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 10px;
    border-radius: 8px;
    background: #f8f9fa;
}
.check.passed { background: #d4edda; }
.check.pending { background: #fff3cd; }
.check .icon { font-size: 24px; }
.check .label { font-size: 12px; margin-top: 5px; }

.btn-block { width: 100%; justify-content: center; }

.form-group {
    margin-bottom: 15px;
}
.form-group label {
    display: block;
    margin-bottom: 5px;
    font-weight: 500;
}
.form-group input, .form-group select {
    width: 100%;
    padding: 10px;
    border: 1px solid #ddd;
    border-radius: 6px;
}

.verification-details, .verification-logs {
    background: white;
    border-radius: 12px;
    padding: 20px;
    margin-bottom: 20px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}
.details-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 15px;
}
.detail-card {
    background: #f8f9fa;
    border-radius: 8px;
    padding: 15px;
}
.detail-card h4 { margin: 0 0 10px 0; }
.detail-card pre {
    background: #2d2d2d;
    color: #f8f8f2;
    padding: 15px;
    border-radius: 6px;
    overflow-x: auto;
    font-size: 12px;
    max-height: 300px;
}

.logs-table { width: 100%; border-collapse: collapse; }
.logs-table th, .logs-table td { padding: 12px; text-align: left; border-bottom: 1px solid #eee; }
.logs-table th { background: #f8f9fa; font-weight: 600; }
.log-type { text-transform: uppercase; font-size: 12px; font-weight: 500; }
.empty { text-align: center; color: #999; padding: 30px; }

.page-actions {
    display: flex;
    justify-content: center;
    gap: 15px;
    padding: 20px;
    background: white;
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

/* Badges */
.badge {
    display: inline-block;
    padding: 2px 8px;
    border-radius: 4px;
    font-size: 12px;
    font-weight: 500;
}
.badge.success { background: #d4edda; color: #155724; }
.badge.warning { background: #fff3cd; color: #856404; }
.badge.danger { background: #f8d7da; color: #721c24; }

.status-badge {
    padding: 5px 15px;
    border-radius: 20px;
    font-size: 14px;
    font-weight: 500;
}
.status-badge.verified { background: #d4edda; color: #155724; }
.status-badge.pending { background: #fff3cd; color: #856404; }
.status-badge.rejected { background: #f8d7da; color: #721c24; }
.status-badge.suspended { background: #e2e3e5; color: #383d41; }

.na { color: #aaa; }

/* Buttons */
.btn {
    display: inline-flex;
    align-items: center;
    gap: 5px;
    padding: 10px 16px;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-size: 14px;
    text-decoration: none;
    background: #e9ecef;
    color: #333;
}
.btn:hover { background: #dee2e6; }
.btn-primary { background: #007bff; color: white; }
.btn-primary:hover { background: #0056b3; }
.btn-success { background: #28a745; color: white; }
.btn-danger { background: #dc3545; color: white; }
.btn-warning { background: #ffc107; color: #333; }
.btn-sm { padding: 5px 10px; }
</style>

<script>
function verifyPartner(id) {
    if (!confirm('–ó–∞–ø—É—Å—Ç–∏—Ç–∏ –ø–æ–≤–Ω—É –ø–µ—Ä–µ–≤—ñ—Ä–∫—É –ø–∞—Ä—Ç–Ω–µ—Ä–∞?')) return;
    
    fetch(`/admin/crm/partner/${id}/verify`, { method: 'POST' })
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                alert('–ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!\n\n' + data.summary);
                location.reload();
            } else {
                alert('–ü–æ–º–∏–ª–∫–∞: ' + data.error);
            }
        });
}

function approvePartner(id) {
    if (!confirm('–ü—ñ–¥—Ç–≤–µ—Ä–¥–∏—Ç–∏ –ø–∞—Ä—Ç–Ω–µ—Ä–∞?')) return;
    
    fetch(`/admin/crm/partner/${id}/approve`, { method: 'POST' })
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                alert('–ü–∞—Ä—Ç–Ω–µ—Ä –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–∏–π!');
                location.reload();
            } else {
                alert('–ü–æ–º–∏–ª–∫–∞: ' + data.error);
            }
        });
}

function rejectPartner(id) {
    const reason = prompt('–ü—Ä–∏—á–∏–Ω–∞ –≤—ñ–¥–º–æ–≤–∏:');
    if (reason === null) return;
    
    fetch(`/admin/crm/partner/${id}/reject`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ reason })
    })
        .then(r => r.json())
        .then(data => {
            if (data.success) location.reload();
            else alert('–ü–æ–º–∏–ª–∫–∞: ' + data.error);
        });
}

function suspendPartner(id) {
    const reason = prompt('–ü—Ä–∏—á–∏–Ω–∞ –ø—Ä–∏–∑—É–ø–∏–Ω–µ–Ω–Ω—è:');
    if (reason === null) return;
    
    fetch(`/admin/crm/partner/${id}/suspend`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ reason })
    })
        .then(r => r.json())
        .then(data => {
            if (data.success) location.reload();
            else alert('–ü–æ–º–∏–ª–∫–∞: ' + data.error);
        });
}

function resolveAlert(id) {
    const note = prompt('–ö–æ–º–µ–Ω—Ç–∞—Ä –¥–æ –≤–∏—Ä—ñ—à–µ–Ω–Ω—è:');
    if (note === null) return;
    
    fetch(`/admin/crm/alert/${id}/resolve`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ note })
    })
        .then(r => r.json())
        .then(data => {
            if (data.success) location.reload();
            else alert('–ü–æ–º–∏–ª–∫–∞: ' + data.error);
        });
}

function showLogDetails(id) {
    fetch(`/admin/crm/verification-log/${id}`)
        .then(r => r.json())
        .then(data => {
            alert(JSON.stringify(data, null, 2));
        });
}
</script>
{% endblock %}
