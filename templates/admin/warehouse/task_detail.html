{% extends "admin/layout.html" %}

{% block title %}üì¶ –ó–∞–≤–¥–∞–Ω–Ω—è {{ task.task_number or '#' ~ task.id }}{% endblock %}

{% block content %}
<div class="task-detail">
    <div class="page-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
        <div>
            <a href="{{ url_for('admin_warehouse') }}" class="btn btn-sm btn-outline">‚Üê –î–æ —Å–ø–∏—Å–∫—É</a>
            <h1 style="margin: 0.5rem 0;">üì¶ –ó–∞–≤–¥–∞–Ω–Ω—è {{ task.task_number or '#' ~ task.id }}</h1>
        </div>
        <div>
            {% if task.status == 'pending' %}
            <span class="status-badge pending">‚è≥ –û—á—ñ–∫—É—î –æ–±—Ä–æ–±–∫–∏</span>
            {% elif task.status == 'processing' %}
            <span class="status-badge processing">üîÑ –í —Ä–æ–±–æ—Ç—ñ</span>
            {% elif task.status == 'packed' %}
            <span class="status-badge packed">üì¶ –ó–∞–ø–∞–∫–æ–≤–∞–Ω–æ</span>
            {% elif task.status == 'ready' %}
            <span class="status-badge ready">‚úÖ –ì–æ—Ç–æ–≤–æ –¥–æ –≤—ñ–¥–ø—Ä–∞–≤–∫–∏</span>
            {% elif task.status == 'shipped' %}
            <span class="status-badge shipped">üöö –í—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–æ</span>
            {% elif task.status == 'delivered' %}
            <span class="status-badge delivered">‚úîÔ∏è –î–æ—Å—Ç–∞–≤–ª–µ–Ω–æ</span>
            {% elif task.status == 'cancelled' %}
            <span class="status-badge cancelled">‚ùå –°–∫–∞—Å–æ–≤–∞–Ω–æ</span>
            {% endif %}
        </div>
    </div>

    <div class="detail-grid" style="display: grid; grid-template-columns: 2fr 1fr; gap: 2rem;">
        <!-- –û—Å–Ω–æ–≤–Ω–∞ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è -->
        <div class="main-info">
            <!-- –Ü–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è –ø—Ä–æ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è -->
            <div class="card">
                <h3>üìã –ó–∞–º–æ–≤–ª–µ–Ω–Ω—è</h3>
                <div class="info-grid">
                    <div class="info-row">
                        <span class="label">ID –ó–∞–º–æ–≤–ª–µ–Ω–Ω—è:</span>
                        <span class="value">
                            {% if task.order %}
                            <a href="{{ url_for('admin_order_detail', order_id=task.order_id) }}">#{{ task.order_id }}</a>
                            {% else %}
                            #{{ task.order_id }}
                            {% endif %}
                        </span>
                    </div>
                    <div class="info-row">
                        <span class="label">–¢–∏–ø:</span>
                        <span class="value">
                            {% if task.is_b2b %}
                            <span class="badge badge-info">B2B</span>
                            {% else %}
                            <span class="badge badge-secondary">B2C</span>
                            {% endif %}
                        </span>
                    </div>
                    <div class="info-row">
                        <span class="label">–ü—Ä—ñ–æ—Ä–∏—Ç–µ—Ç:</span>
                        <span class="value">
                            {% if task.priority == 1 %}
                            <span class="badge badge-danger">üî¥ –¢–µ—Ä–º—ñ–Ω–æ–≤–æ</span>
                            {% elif task.priority == 2 %}
                            <span class="badge badge-warning">üü° –í–∏—Å–æ–∫–∏–π</span>
                            {% else %}
                            <span class="badge badge-secondary">‚ö™ –ó–≤–∏—á–∞–π–Ω–∏–π</span>
                            {% endif %}
                        </span>
                    </div>
                    <div class="info-row">
                        <span class="label">–°—Ç–≤–æ—Ä–µ–Ω–æ:</span>
                        <span class="value">{{ task.created_at.strftime('%d.%m.%Y %H:%M') }}</span>
                    </div>
                </div>
            </div>

            <!-- –Ü–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è –ø—Ä–æ –∫–ª—ñ—î–Ω—Ç–∞ -->
            <div class="card">
                <h3>üë§ –ö–ª—ñ—î–Ω—Ç</h3>
                <div class="info-grid">
                    <div class="info-row">
                        <span class="label">–Ü–º'—è:</span>
                        <span class="value">{{ task.customer_name or '‚Äî' }}</span>
                    </div>
                    <div class="info-row">
                        <span class="label">–¢–µ–ª–µ—Ñ–æ–Ω:</span>
                        <span class="value">{{ task.customer_phone or '‚Äî' }}</span>
                    </div>
                    <div class="info-row">
                        <span class="label">Email:</span>
                        <span class="value">{{ task.customer_email or '‚Äî' }}</span>
                    </div>
                </div>
            </div>

            <!-- –ê–¥—Ä–µ—Å–∞ –¥–æ—Å—Ç–∞–≤–∫–∏ -->
            <div class="card">
                <h3>üìç –ê–¥—Ä–µ—Å–∞ –¥–æ—Å—Ç–∞–≤–∫–∏</h3>
                <p style="font-size: 1.1rem; margin: 0;">{{ task.shipping_address or '‚Äî' }}</p>
                {% if task.shipping_method %}
                <p style="margin-top: 0.5rem; color: #666;">
                    –°–ø–æ—Å—ñ–±: <strong>{{ task.shipping_method }}</strong>
                </p>
                {% endif %}
            </div>

            <!-- –¢–æ–≤–∞—Ä–∏ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è -->
            {% if task.order and task.order.items %}
            <div class="card">
                <h3>üì¶ –¢–æ–≤–∞—Ä–∏ –¥–ª—è –≤—ñ–¥–ø—Ä–∞–≤–∫–∏</h3>
                <table class="admin-table" style="margin: 0;">
                    <thead>
                        <tr>
                            <th>–¢–æ–≤–∞—Ä</th>
                            <th>SKU</th>
                            <th>–ö—ñ–ª—å–∫—ñ—Å—Ç—å</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in task.order.items %}
                        <tr>
                            <td>{{ item.product.name if item.product else item.product_name }}</td>
                            <td><code>{{ item.product.sku if item.product else '‚Äî' }}</code></td>
                            <td><strong>{{ item.quantity }}</strong> —à—Ç.</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% endif %}

            <!-- –Ü–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è –ø—Ä–æ –≤—ñ–¥–ø—Ä–∞–≤–∫—É -->
            {% if task.status in ['shipped', 'delivered'] %}
            <div class="card">
                <h3>üöö –Ü–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è –ø—Ä–æ –≤—ñ–¥–ø—Ä–∞–≤–∫—É</h3>
                <div class="info-grid">
                    <div class="info-row">
                        <span class="label">–ü–µ—Ä–µ–≤—ñ–∑–Ω–∏–∫:</span>
                        <span class="value">{{ task.carrier or '‚Äî' }}</span>
                    </div>
                    <div class="info-row">
                        <span class="label">–ù–æ–º–µ—Ä –≤—ñ–¥—Å—Ç–µ–∂–µ–Ω–Ω—è:</span>
                        <span class="value"><code>{{ task.tracking_number or '‚Äî' }}</code></span>
                    </div>
                    <div class="info-row">
                        <span class="label">–í—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–æ:</span>
                        <span class="value">{{ task.shipped_at.strftime('%d.%m.%Y %H:%M') if task.shipped_at else '‚Äî' }}</span>
                    </div>
                    {% if task.delivered_at %}
                    <div class="info-row">
                        <span class="label">–î–æ—Å—Ç–∞–≤–ª–µ–Ω–æ:</span>
                        <span class="value">{{ task.delivered_at.strftime('%d.%m.%Y %H:%M') }}</span>
                    </div>
                    {% endif %}
                    {% if task.weight_kg %}
                    <div class="info-row">
                        <span class="label">–í–∞–≥–∞:</span>
                        <span class="value">{{ task.weight_kg }} –∫–≥</span>
                    </div>
                    {% endif %}
                    {% if task.dimensions %}
                    <div class="info-row">
                        <span class="label">–†–æ–∑–º—ñ—Ä–∏:</span>
                        <span class="value">{{ task.dimensions }}</span>
                    </div>
                    {% endif %}
                </div>
            </div>
            {% endif %}

            <!-- –ù–æ—Ç–∞—Ç–∫–∏ -->
            <div class="card">
                <h3>üìù –ù–æ—Ç–∞—Ç–∫–∏</h3>
                <form method="POST">
                    <input type="hidden" name="action" value="update_notes">
                    <textarea name="admin_notes" rows="4" style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;">{{ task.admin_notes or '' }}</textarea>
                    <button type="submit" class="btn btn-sm btn-secondary" style="margin-top: 0.5rem;">üíæ –ó–±–µ—Ä–µ–≥—Ç–∏ –Ω–æ—Ç–∞—Ç–∫–∏</button>
                </form>
            </div>
        </div>

        <!-- –ü–∞–Ω–µ–ª—å –¥—ñ–π -->
        <div class="actions-panel">
            <div class="card">
                <h3>‚ö° –î—ñ—ó</h3>
                
                {% if task.status == 'pending' %}
                <form method="POST" style="margin-bottom: 1rem;">
                    <input type="hidden" name="action" value="start_processing">
                    <div class="form-group">
                        <label>–í–∏–∫–æ–Ω–∞–≤–µ—Ü—å:</label>
                        <input type="text" name="assigned_to" class="form-control" placeholder="–Ü–º'—è –ø—Ä–∞—Ü—ñ–≤–Ω–∏–∫–∞">
                    </div>
                    <button type="submit" class="btn btn-primary btn-block">üîÑ –í–∑—è—Ç–∏ –≤ —Ä–æ–±–æ—Ç—É</button>
                </form>
                {% endif %}

                {% if task.status == 'processing' %}
                <form method="POST" style="margin-bottom: 1rem;">
                    <input type="hidden" name="action" value="mark_packed">
                    <div class="form-group">
                        <label>–í–∞–≥–∞ (–∫–≥):</label>
                        <input type="number" name="weight_kg" step="0.01" class="form-control" placeholder="0.5">
                    </div>
                    <div class="form-group">
                        <label>–†–æ–∑–º—ñ—Ä–∏:</label>
                        <input type="text" name="dimensions" class="form-control" placeholder="30x20x10 —Å–º">
                    </div>
                    <button type="submit" class="btn btn-info btn-block">üì¶ –ó–∞–ø–∞–∫–æ–≤–∞–Ω–æ</button>
                </form>
                {% endif %}

                {% if task.status == 'packed' %}
                <form method="POST" style="margin-bottom: 1rem;">
                    <input type="hidden" name="action" value="mark_ready">
                    <button type="submit" class="btn btn-success btn-block">‚úÖ –ì–æ—Ç–æ–≤–æ –¥–æ –≤—ñ–¥–ø—Ä–∞–≤–∫–∏</button>
                </form>
                {% endif %}

                {% if task.status == 'ready' %}
                <form method="POST" style="margin-bottom: 1rem;">
                    <input type="hidden" name="action" value="mark_shipped">
                    <div class="form-group">
                        <label>–ü–µ—Ä–µ–≤—ñ–∑–Ω–∏–∫:</label>
                        <select name="carrier" class="form-control">
                            <option value="Nova Poshta">–ù–æ–≤–∞ –ü–æ—à—Ç–∞</option>
                            <option value="Ukrposhta">–£–∫—Ä–ø–æ—à—Ç–∞</option>
                            <option value="Meest">Meest</option>
                            <option value="DHL">DHL</option>
                            <option value="UPS">UPS</option>
                            <option value="Other">–Ü–Ω—à–∏–π</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>–ù–æ–º–µ—Ä –¢–¢–ù:</label>
                        <input type="text" name="tracking_number" class="form-control" placeholder="20450000000001" required>
                    </div>
                    <button type="submit" class="btn btn-warning btn-block">üöö –í—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–æ</button>
                </form>
                {% endif %}

                {% if task.status == 'shipped' %}
                <form method="POST" style="margin-bottom: 1rem;">
                    <input type="hidden" name="action" value="mark_delivered">
                    <button type="submit" class="btn btn-success btn-block">‚úîÔ∏è –î–æ—Å—Ç–∞–≤–ª–µ–Ω–æ</button>
                </form>
                {% endif %}

                {% if task.status not in ['delivered', 'cancelled'] %}
                <hr style="margin: 1.5rem 0;">
                <form method="POST" onsubmit="return confirm('–í–∏ –≤–ø–µ–≤–Ω–µ–Ω—ñ —â–æ —Ö–æ—á–µ—Ç–µ —Å–∫–∞—Å—É–≤–∞—Ç–∏ —Ü–µ –∑–∞–≤–¥–∞–Ω–Ω—è?');">
                    <input type="hidden" name="action" value="cancel">
                    <div class="form-group">
                        <label>–ü—Ä–∏—á–∏–Ω–∞ —Å–∫–∞—Å—É–≤–∞–Ω–Ω—è:</label>
                        <textarea name="cancel_reason" class="form-control" rows="2"></textarea>
                    </div>
                    <button type="submit" class="btn btn-danger btn-block">‚ùå –°–∫–∞—Å—É–≤–∞—Ç–∏</button>
                </form>
                {% endif %}
            </div>

            <!-- –Ü–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è –ø—Ä–æ –≤–∏–∫–æ–Ω–∞–≤—Ü—è -->
            {% if task.assigned_to %}
            <div class="card">
                <h3>üë∑ –í–∏–∫–æ–Ω–∞–≤–µ—Ü—å</h3>
                <p style="font-size: 1.2rem; margin: 0;">{{ task.assigned_to }}</p>
            </div>
            {% endif %}

            <!-- –®–≤–∏–¥–∫—ñ –ø–æ—Å–∏–ª–∞–Ω–Ω—è -->
            <div class="card">
                <h3>üîó –ü–æ—Å–∏–ª–∞–Ω–Ω—è</h3>
                <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                    <a href="{{ url_for('admin_warehouse') }}" class="btn btn-outline btn-block">üì¶ –í—Å—ñ –∑–∞–≤–¥–∞–Ω–Ω—è</a>
                    <a href="{{ url_for('admin_warehouse_stock') }}" class="btn btn-outline btn-block">üìä –ó–∞–ª–∏—à–∫–∏</a>
                    {% if task.order %}
                    <a href="{{ url_for('admin_order_detail', order_id=task.order_id) }}" class="btn btn-outline btn-block">üßæ –ó–∞–º–æ–≤–ª–µ–Ω–Ω—è</a>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.card {
    background: white;
    border-radius: 12px;
    padding: 1.5rem;
    margin-bottom: 1.5rem;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}
.card h3 {
    margin: 0 0 1rem 0;
    padding-bottom: 0.5rem;
    border-bottom: 1px solid #eee;
}

.status-badge {
    padding: 0.5rem 1rem;
    border-radius: 20px;
    font-weight: 500;
    font-size: 1rem;
}
.status-badge.pending { background: #f8f9fa; color: #6c757d; }
.status-badge.processing { background: #e3f2fd; color: #1976d2; }
.status-badge.packed { background: #e8f5e9; color: #388e3c; }
.status-badge.ready { background: #fff3e0; color: #f57c00; }
.status-badge.shipped { background: #ffc107; color: #333; }
.status-badge.delivered { background: #28a745; color: white; }
.status-badge.cancelled { background: #dc3545; color: white; }

.info-grid { display: flex; flex-direction: column; gap: 0.5rem; }
.info-row { display: flex; justify-content: space-between; padding: 0.5rem 0; border-bottom: 1px solid #f5f5f5; }
.info-row:last-child { border-bottom: none; }
.info-row .label { color: #666; }
.info-row .value { font-weight: 500; }

.form-group { margin-bottom: 1rem; }
.form-group label { display: block; margin-bottom: 0.25rem; font-weight: 500; font-size: 0.9rem; }
.form-control { width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px; }

.btn-block { width: 100%; display: block; text-align: center; }
.btn-outline { background: transparent; border: 1px solid #ddd; color: #333; }
.btn-outline:hover { background: #f5f5f5; }
</style>
{% endblock %}
