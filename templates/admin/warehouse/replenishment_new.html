{% extends "admin/layout.html" %}

{% block title %}‚ûï –ù–æ–≤–µ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è –Ω–∞ –ø–æ–ø–æ–≤–Ω–µ–Ω–Ω—è{% endblock %}

{% block content %}
<div class="replenishment-new">
    <div class="page-header" style="margin-bottom: 2rem;">
        <a href="{{ url_for('admin_warehouse_replenishment') }}" class="btn btn-sm btn-outline">‚Üê –î–æ —Å–ø–∏—Å–∫—É</a>
        <h1 style="margin: 0.5rem 0;">‚ûï –ù–æ–≤–µ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è –Ω–∞ –ø–æ–ø–æ–≤–Ω–µ–Ω–Ω—è</h1>
    </div>

    <form method="POST" id="replenishmentForm">
        <div class="form-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;">
            <!-- –õ—ñ–≤–∞ –∫–æ–ª–æ–Ω–∫–∞ - –ø–æ—Å—Ç–∞—á–∞–ª—å–Ω–∏–∫ -->
            <div class="card">
                <h3>üì¶ –ü–æ—Å—Ç–∞—á–∞–ª—å–Ω–∏–∫</h3>
                
                <div class="form-group">
                    <label>–ù–∞–∑–≤–∞ –ø–æ—Å—Ç–∞—á–∞–ª—å–Ω–∏–∫–∞ *</label>
                    <input type="text" name="supplier_name" class="form-control" placeholder="–¢–û–í '–ü–æ—Å—Ç–∞—á–∞–ª—å–Ω–∏–∫'" required>
                </div>
                
                <div class="form-group">
                    <label>–ö–æ–Ω—Ç–∞–∫—Ç–Ω–∞ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è</label>
                    <textarea name="supplier_contact" class="form-control" rows="3" placeholder="–¢–µ–ª–µ—Ñ–æ–Ω, email, –∫–æ–Ω—Ç–∞–∫—Ç–Ω–∞ –æ—Å–æ–±–∞..."></textarea>
                </div>
                
                <div class="form-group">
                    <label>–ü—Ä–∏–º—ñ—Ç–∫–∏ –¥–æ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è</label>
                    <textarea name="notes" class="form-control" rows="3" placeholder="–î–æ–¥–∞—Ç–∫–æ–≤—ñ –ø–æ–±–∞–∂–∞–Ω–Ω—è..."></textarea>
                </div>
            </div>

            <!-- –ü—Ä–∞–≤–∞ –∫–æ–ª–æ–Ω–∫–∞ - —à–≤–∏–¥–∫–∏–π –≤–∏–±—ñ—Ä -->
            {% if low_stock_products %}
            <div class="card">
                <h3>‚ö†Ô∏è –¢–æ–≤–∞—Ä–∏ –∑ –Ω–∏–∑—å–∫–∏–º –∑–∞–ª–∏—à–∫–æ–º</h3>
                <p class="text-muted">–ù–∞—Ç–∏—Å–Ω—ñ—Ç—å —â–æ–± —à–≤–∏–¥–∫–æ –¥–æ–¥–∞—Ç–∏ –¥–æ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è:</p>
                <div class="quick-add-list" style="max-height: 300px; overflow-y: auto;">
                    {% for product in low_stock_products %}
                    <div class="quick-add-item" onclick="addProduct({{ product.id }}, '{{ product.name|e }}', '{{ product.sku or '' }}')" 
                         style="padding: 0.5rem; border-bottom: 1px solid #eee; cursor: pointer; transition: background 0.2s;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <strong>{{ product.name }}</strong>
                                {% if product.sku %}<br><small class="text-muted">{{ product.sku }}</small>{% endif %}
                            </div>
                            <div style="text-align: right;">
                                <span class="badge badge-warning">{{ product.stock }}/{{ product.min_stock }}</span>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
        </div>

        <!-- –¢–æ–≤–∞—Ä–∏ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è -->
        <div class="card" style="margin-top: 2rem;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                <h3 style="margin: 0;">üìã –¢–æ–≤–∞—Ä–∏ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è</h3>
                <button type="button" class="btn btn-sm btn-success" onclick="addEmptyRow()">
                    ‚ûï –î–æ–¥–∞—Ç–∏ —Ç–æ–≤–∞—Ä
                </button>
            </div>

            <table class="admin-table" id="itemsTable">
                <thead>
                    <tr>
                        <th style="width: 40%;">–¢–æ–≤–∞—Ä</th>
                        <th style="width: 15%;">–ö—ñ–ª—å–∫—ñ—Å—Ç—å</th>
                        <th style="width: 20%;">–¶—ñ–Ω–∞ –∑–∞ –æ–¥.</th>
                        <th style="width: 15%;">–°—É–º–∞</th>
                        <th style="width: 10%;"></th>
                    </tr>
                </thead>
                <tbody id="itemsBody">
                    <!-- –†—è–¥–∫–∏ –¥–æ–¥–∞—é—Ç—å—Å—è –¥–∏–Ω–∞–º—ñ—á–Ω–æ -->
                </tbody>
                <tfoot>
                    <tr>
                        <td colspan="3" style="text-align: right;"><strong>–ó–∞–≥–∞–ª—å–Ω–∞ —Å—É–º–∞:</strong></td>
                        <td><strong id="totalSum">0.00</strong> UAH</td>
                        <td></td>
                    </tr>
                </tfoot>
            </table>
        </div>

        <!-- –ö–Ω–æ–ø–∫–∏ -->
        <div style="margin-top: 2rem; display: flex; gap: 1rem; justify-content: flex-end;">
            <a href="{{ url_for('admin_warehouse_replenishment') }}" class="btn btn-outline">–°–∫–∞—Å—É–≤–∞—Ç–∏</a>
            <button type="submit" class="btn btn-primary">üíæ –°—Ç–≤–æ—Ä–∏—Ç–∏ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è</button>
        </div>
    </form>
</div>

<!-- –î–∞—Ç–∞—Å–µ—Ç –≤—Å—ñ—Ö —Ç–æ–≤–∞—Ä—ñ–≤ –¥–ª—è –∞–≤—Ç–æ–¥–æ–ø–æ–≤–Ω–µ–Ω–Ω—è -->
<script>
const allProducts = [
    {% for product in products %}
    { id: {{ product.id }}, name: "{{ product.name|e }}", sku: "{{ product.sku or ''|e }}" },
    {% endfor %}
];

let rowIndex = 0;

function addProduct(id, name, sku) {
    // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ —á–∏ —Ç–æ–≤–∞—Ä –≤–∂–µ –¥–æ–¥–∞–Ω–æ
    const existing = document.querySelector(`input[name="product_ids"][value="${id}"]`);
    if (existing) {
        // –Ø–∫—â–æ —î - –∑–±—ñ–ª—å—à—É—î–º–æ –∫—ñ–ª—å–∫—ñ—Å—Ç—å
        const row = existing.closest('tr');
        const qtyInput = row.querySelector('input[name="quantities"]');
        qtyInput.value = parseInt(qtyInput.value || 0) + 1;
        calculateRowSum(row);
        return;
    }
    
    addRow(id, name, sku, 1, 0);
}

function addEmptyRow() {
    addRow('', '', '', 1, 0);
}

function addRow(productId, productName, productSku, qty, price) {
    rowIndex++;
    const tbody = document.getElementById('itemsBody');
    
    const tr = document.createElement('tr');
    tr.innerHTML = `
        <td>
            <input type="hidden" name="product_ids" value="${productId}">
            <select class="form-control product-select" onchange="onProductSelect(this)">
                <option value="">-- –û–±–µ—Ä—ñ—Ç—å —Ç–æ–≤–∞—Ä --</option>
                ${allProducts.map(p => `<option value="${p.id}" ${p.id == productId ? 'selected' : ''}>${p.name} ${p.sku ? '(' + p.sku + ')' : ''}</option>`).join('')}
            </select>
        </td>
        <td>
            <input type="number" name="quantities" value="${qty}" min="1" class="form-control" onchange="calculateRowSum(this.closest('tr'))">
        </td>
        <td>
            <input type="number" name="prices" value="${price}" min="0" step="0.01" class="form-control" onchange="calculateRowSum(this.closest('tr'))" placeholder="0.00">
        </td>
        <td class="row-sum">0.00</td>
        <td>
            <button type="button" class="btn btn-sm btn-danger" onclick="removeRow(this)">üóëÔ∏è</button>
        </td>
    `;
    
    tbody.appendChild(tr);
    calculateTotal();
}

function onProductSelect(select) {
    const row = select.closest('tr');
    const hiddenInput = row.querySelector('input[name="product_ids"]');
    hiddenInput.value = select.value;
}

function removeRow(btn) {
    btn.closest('tr').remove();
    calculateTotal();
}

function calculateRowSum(row) {
    const qty = parseFloat(row.querySelector('input[name="quantities"]').value) || 0;
    const price = parseFloat(row.querySelector('input[name="prices"]').value) || 0;
    const sum = qty * price;
    row.querySelector('.row-sum').textContent = sum.toFixed(2);
    calculateTotal();
}

function calculateTotal() {
    let total = 0;
    document.querySelectorAll('.row-sum').forEach(cell => {
        total += parseFloat(cell.textContent) || 0;
    });
    document.getElementById('totalSum').textContent = total.toFixed(2);
}

// Hover –µ—Ñ–µ–∫—Ç –¥–ª—è quick-add
document.querySelectorAll('.quick-add-item').forEach(item => {
    item.addEventListener('mouseenter', () => item.style.background = '#f5f5f5');
    item.addEventListener('mouseleave', () => item.style.background = 'transparent');
});
</script>

<style>
.card {
    background: white;
    border-radius: 12px;
    padding: 1.5rem;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}
.card h3 {
    margin: 0 0 1rem 0;
    padding-bottom: 0.5rem;
    border-bottom: 1px solid #eee;
}

.form-group { margin-bottom: 1rem; }
.form-group label { display: block; margin-bottom: 0.25rem; font-weight: 500; }
.form-control { width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px; }

.badge { padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; }
.badge-warning { background: #ffc107; color: #333; }

.btn-outline { background: transparent; border: 1px solid #ddd; color: #333; }
.btn-outline:hover { background: #f5f5f5; }

.row-sum { font-weight: bold; }
</style>
{% endblock %}
