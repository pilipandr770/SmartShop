{% extends "admin/layout.html" %}

{% block title %}üì• –ó–∞–º–æ–≤–ª–µ–Ω–Ω—è {{ order.order_number or '#' ~ order.id }}{% endblock %}

{% block content %}
<div class="replenishment-detail">
    <div class="page-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
        <div>
            <a href="{{ url_for('admin_warehouse_replenishment') }}" class="btn btn-sm btn-outline">‚Üê –î–æ —Å–ø–∏—Å–∫—É</a>
            <h1 style="margin: 0.5rem 0;">üì• –ó–∞–º–æ–≤–ª–µ–Ω–Ω—è {{ order.order_number or '#' ~ order.id }}</h1>
        </div>
        <div>
            {% if order.status == 'draft' %}
            <span class="status-badge draft">üìù –ß–µ—Ä–Ω–µ—Ç–∫–∞</span>
            {% elif order.status == 'pending' %}
            <span class="status-badge pending">‚è≥ –û—á—ñ–∫—É—î –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è</span>
            {% elif order.status == 'approved' %}
            <span class="status-badge approved">‚úÖ –ó–∞—Ç–≤–µ—Ä–¥–∂–µ–Ω–æ</span>
            {% elif order.status == 'ordered' %}
            <span class="status-badge ordered">üì§ –ó–∞–º–æ–≤–ª–µ–Ω–æ</span>
            {% elif order.status == 'shipped' %}
            <span class="status-badge shipped">üöö –í –¥–æ—Ä–æ–∑—ñ</span>
            {% elif order.status == 'received' %}
            <span class="status-badge received">‚úîÔ∏è –û—Ç—Ä–∏–º–∞–Ω–æ</span>
            {% elif order.status == 'cancelled' %}
            <span class="status-badge cancelled">‚ùå –°–∫–∞—Å–æ–≤–∞–Ω–æ</span>
            {% endif %}
            
            {% if order.is_paid %}
            <span class="status-badge paid">üí∞ –û–ø–ª–∞—á–µ–Ω–æ</span>
            {% endif %}
        </div>
    </div>

    <div class="detail-grid" style="display: grid; grid-template-columns: 2fr 1fr; gap: 2rem;">
        <!-- –û—Å–Ω–æ–≤–Ω–∞ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è -->
        <div class="main-info">
            <!-- –ü–æ—Å—Ç–∞—á–∞–ª—å–Ω–∏–∫ -->
            <div class="card">
                <h3>üì¶ –ü–æ—Å—Ç–∞—á–∞–ª—å–Ω–∏–∫</h3>
                <div class="info-grid">
                    <div class="info-row">
                        <span class="label">–ù–∞–∑–≤–∞:</span>
                        <span class="value">{{ order.supplier_name or '‚Äî' }}</span>
                    </div>
                    <div class="info-row">
                        <span class="label">–ö–æ–Ω—Ç–∞–∫—Ç–∏:</span>
                        <span class="value">{{ order.supplier_contact or '‚Äî' }}</span>
                    </div>
                </div>
            </div>

            <!-- –¢–æ–≤–∞—Ä–∏ -->
            <div class="card">
                <h3>üìã –¢–æ–≤–∞—Ä–∏</h3>
                <table class="admin-table" style="margin: 0;">
                    <thead>
                        <tr>
                            <th>–¢–æ–≤–∞—Ä</th>
                            <th>SKU</th>
                            <th>–ö—ñ–ª—å–∫—ñ—Å—Ç—å</th>
                            <th>–¶—ñ–Ω–∞</th>
                            <th>–°—É–º–∞</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in order.items %}
                        <tr>
                            <td>{{ item.product_name }}</td>
                            <td><code>{{ item.product_sku or '‚Äî' }}</code></td>
                            <td>{{ item.quantity }}</td>
                            <td>{{ "%.2f"|format(item.unit_price) if item.unit_price else '‚Äî' }}</td>
                            <td><strong>{{ "%.2f"|format(item.total) if item.total else '‚Äî' }}</strong></td>
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="5" class="text-center text-muted">–ù–µ–º–∞—î —Ç–æ–≤–∞—Ä—ñ–≤</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                    <tfoot>
                        <tr>
                            <td colspan="4" style="text-align: right;"><strong>–ó–∞–≥–∞–ª—å–Ω–∞ —Å—É–º–∞:</strong></td>
                            <td><strong>{{ "%.2f"|format(order.total) if order.total else '0.00' }}</strong> {{ order.currency or 'UAH' }}</td>
                        </tr>
                    </tfoot>
                </table>
            </div>

            <!-- –Ü–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è –ø—Ä–æ –¥–æ—Å—Ç–∞–≤–∫—É/–æ—Ç—Ä–∏–º–∞–Ω–Ω—è -->
            {% if order.status in ['shipped', 'received'] %}
            <div class="card">
                <h3>üöö –î–æ—Å—Ç–∞–≤–∫–∞</h3>
                <div class="info-grid">
                    {% if order.expected_at %}
                    <div class="info-row">
                        <span class="label">–û—á—ñ–∫—É–≤–∞–Ω–∞ –¥–∞—Ç–∞:</span>
                        <span class="value">{{ order.expected_at.strftime('%d.%m.%Y') }}</span>
                    </div>
                    {% endif %}
                    {% if order.received_at %}
                    <div class="info-row">
                        <span class="label">–û—Ç—Ä–∏–º–∞–Ω–æ:</span>
                        <span class="value">{{ order.received_at.strftime('%d.%m.%Y %H:%M') }}</span>
                    </div>
                    {% endif %}
                </div>
            </div>
            {% endif %}

            <!-- –ü—Ä–∏–º—ñ—Ç–∫–∏ -->
            {% if order.notes %}
            <div class="card">
                <h3>üìù –ü—Ä–∏–º—ñ—Ç–∫–∏</h3>
                <p style="margin: 0; white-space: pre-wrap;">{{ order.notes }}</p>
            </div>
            {% endif %}

            <!-- –Ü–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è –ø—Ä–æ –æ–ø–ª–∞—Ç—É -->
            {% if order.is_paid %}
            <div class="card">
                <h3>üí∞ –û–ø–ª–∞—Ç–∞</h3>
                <div class="info-grid">
                    <div class="info-row">
                        <span class="label">–°–ø–æ—Å—ñ–± –æ–ø–ª–∞—Ç–∏:</span>
                        <span class="value">{{ order.payment_method or '‚Äî' }}</span>
                    </div>
                    <div class="info-row">
                        <span class="label">–î–∞—Ç–∞ –æ–ø–ª–∞—Ç–∏:</span>
                        <span class="value">{{ order.paid_at.strftime('%d.%m.%Y %H:%M') if order.paid_at else '‚Äî' }}</span>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>

        <!-- –ü–∞–Ω–µ–ª—å –¥—ñ–π -->
        <div class="actions-panel">
            <div class="card">
                <h3>‚ö° –î—ñ—ó</h3>
                
                {% if order.status == 'draft' %}
                <form method="POST" style="margin-bottom: 1rem;">
                    <input type="hidden" name="action" value="approve">
                    <button type="submit" class="btn btn-info btn-block">‚úÖ –ü—ñ–¥—Ç–≤–µ—Ä–¥–∏—Ç–∏</button>
                </form>
                {% endif %}

                {% if order.status in ['pending', 'approved'] %}
                <form method="POST" style="margin-bottom: 1rem;">
                    <input type="hidden" name="action" value="order">
                    <button type="submit" class="btn btn-primary btn-block">üì§ –ó–∞–º–æ–≤–∏—Ç–∏ —É –ø–æ—Å—Ç–∞—á–∞–ª—å–Ω–∏–∫–∞</button>
                </form>
                {% endif %}

                {% if order.status == 'ordered' %}
                <form method="POST" style="margin-bottom: 1rem;">
                    <input type="hidden" name="action" value="shipped">
                    <button type="submit" class="btn btn-info btn-block">üöö –í—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–æ</button>
                </form>
                {% endif %}

                {% if order.status == 'shipped' %}
                <form method="POST" style="margin-bottom: 1rem;">
                    <input type="hidden" name="action" value="receive">
                    <button type="submit" class="btn btn-success btn-block">‚úîÔ∏è –û—Ç—Ä–∏–º–∞–Ω–æ (–æ–Ω–æ–≤–∏—Ç–∏ –∑–∞–ª–∏—à–∫–∏)</button>
                </form>
                {% endif %}

                {% if order.status not in ['received', 'cancelled'] %}
                <hr style="margin: 1.5rem 0;">
                <form method="POST" onsubmit="return confirm('–í–∏ –≤–ø–µ–≤–Ω–µ–Ω—ñ —â–æ —Ö–æ—á–µ—Ç–µ —Å–∫–∞—Å—É–≤–∞—Ç–∏ —Ü–µ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è?');">
                    <input type="hidden" name="action" value="cancel">
                    <button type="submit" class="btn btn-danger btn-block">‚ùå –°–∫–∞—Å—É–≤–∞—Ç–∏</button>
                </form>
                {% endif %}
                
                {% if not order.is_paid and order.status != 'cancelled' %}
                <hr style="margin: 1.5rem 0;">
                <form method="POST">
                    <input type="hidden" name="action" value="mark_paid">
                    <div class="form-group">
                        <label>–°–ø–æ—Å—ñ–± –æ–ø–ª–∞—Ç–∏:</label>
                        <select name="payment_method" class="form-control">
                            <option value="bank_transfer">–ë–∞–Ω–∫—ñ–≤—Å—å–∫–∏–π –ø–µ—Ä–µ–∫–∞–∑</option>
                            <option value="cash">–ì–æ—Ç—ñ–≤–∫–∞</option>
                            <option value="card">–ö–∞—Ä—Ç–∞</option>
                        </select>
                    </div>
                    <button type="submit" class="btn btn-success btn-block">üí∞ –ó–∞—Ñ—ñ–∫—Å—É–≤–∞—Ç–∏ –æ–ø–ª–∞—Ç—É</button>
                </form>
                {% endif %}
            </div>

            <!-- –Ü–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è -->
            <div class="card">
                <h3>üìä –Ü–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è</h3>
                <div class="info-grid">
                    <div class="info-row">
                        <span class="label">–°—Ç–≤–æ—Ä–µ–Ω–æ:</span>
                        <span class="value">{{ order.created_at.strftime('%d.%m.%Y') }}</span>
                    </div>
                    <div class="info-row">
                        <span class="label">–ê–≤—Ç–æ—Ä:</span>
                        <span class="value">{{ order.created_by or '‚Äî' }}</span>
                    </div>
                    {% if order.ordered_at %}
                    <div class="info-row">
                        <span class="label">–ó–∞–º–æ–≤–ª–µ–Ω–æ:</span>
                        <span class="value">{{ order.ordered_at.strftime('%d.%m.%Y') }}</span>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.card {
    background: white;
    border-radius: 12px;
    padding: 1.5rem;
    margin-bottom: 1.5rem;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}
.card h3 {
    margin: 0 0 1rem 0;
    padding-bottom: 0.5rem;
    border-bottom: 1px solid #eee;
}

.status-badge {
    padding: 0.5rem 1rem;
    border-radius: 20px;
    font-weight: 500;
    font-size: 0.9rem;
    margin-left: 0.5rem;
}
.status-badge.draft { background: #f8f9fa; color: #6c757d; }
.status-badge.pending { background: #fff3cd; color: #856404; }
.status-badge.approved { background: #d1ecf1; color: #0c5460; }
.status-badge.ordered { background: #cce5ff; color: #004085; }
.status-badge.shipped { background: #17a2b8; color: white; }
.status-badge.received { background: #28a745; color: white; }
.status-badge.cancelled { background: #dc3545; color: white; }
.status-badge.paid { background: #28a745; color: white; }

.info-grid { display: flex; flex-direction: column; gap: 0.5rem; }
.info-row { display: flex; justify-content: space-between; padding: 0.5rem 0; border-bottom: 1px solid #f5f5f5; }
.info-row:last-child { border-bottom: none; }
.info-row .label { color: #666; }
.info-row .value { font-weight: 500; }

.form-group { margin-bottom: 1rem; }
.form-group label { display: block; margin-bottom: 0.25rem; font-weight: 500; font-size: 0.9rem; }
.form-control { width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px; }

.btn-block { width: 100%; display: block; text-align: center; }
.btn-outline { background: transparent; border: 1px solid #ddd; color: #333; }
.btn-outline:hover { background: #f5f5f5; }
</style>
{% endblock %}
