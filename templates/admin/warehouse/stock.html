{% extends "admin/layout.html" %}

{% block title %}üìä –°–∫–ª–∞–¥ - –ó–∞–ª–∏—à–∫–∏{% endblock %}

{% block content %}
<div class="stock-dashboard">
    <div class="page-header">
        <h1>üìä –ó–∞–ª–∏—à–∫–∏ –Ω–∞ —Å–∫–ª–∞–¥—ñ</h1>
    </div>

    <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
    <div class="stats-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 2rem;">
        <div class="stat-card">
            <div class="stat-icon">üì¶</div>
            <div class="stat-info">
                <span class="stat-value">{{ stats.total_products }}</span>
                <span class="stat-label">–í—Å—å–æ–≥–æ —Ç–æ–≤–∞—Ä—ñ–≤</span>
            </div>
        </div>
        <div class="stat-card warning">
            <div class="stat-icon">‚ö†Ô∏è</div>
            <div class="stat-info">
                <span class="stat-value">{{ stats.low_stock }}</span>
                <span class="stat-label">–ó–∞–∫—ñ–Ω—á—É—é—Ç—å—Å—è</span>
            </div>
        </div>
        <div class="stat-card danger">
            <div class="stat-icon">‚ùå</div>
            <div class="stat-info">
                <span class="stat-value">{{ stats.out_of_stock }}</span>
                <span class="stat-label">–ù–µ–º–∞—î –≤ –Ω–∞—è–≤–Ω–æ—Å—Ç—ñ</span>
            </div>
        </div>
        <div class="stat-card info">
            <div class="stat-icon">üîî</div>
            <div class="stat-info">
                <span class="stat-value">{{ stats.unresolved_alerts }}</span>
                <span class="stat-label">–ê–∫—Ç–∏–≤–Ω–∏—Ö —Å–ø–æ–≤—ñ—â–µ–Ω—å</span>
            </div>
        </div>
    </div>

    <!-- –§—ñ–ª—å—Ç—Ä–∏ —Ç–∞ –ø–æ—à—É–∫ -->
    <div class="filters-bar" style="margin-bottom: 1.5rem; display: flex; gap: 1rem; flex-wrap: wrap; align-items: center;">
        <form method="GET" style="display: flex; gap: 0.5rem; flex-grow: 1;">
            <input type="text" name="search" value="{{ search }}" placeholder="üîç –ü–æ—à—É–∫ –∑–∞ –Ω–∞–∑–≤–æ—é –∞–±–æ SKU..." 
                   class="form-control" style="max-width: 300px;">
            <button type="submit" class="btn btn-primary">–ó–Ω–∞–π—Ç–∏</button>
        </form>
        
        <a href="{{ url_for('admin_warehouse_stock') }}" 
           class="btn {% if not show_low %}btn-primary{% else %}btn-outline{% endif %}">
            –í—Å—ñ —Ç–æ–≤–∞—Ä–∏
        </a>
        <a href="{{ url_for('admin_warehouse_stock', low=1) }}" 
           class="btn {% if show_low %}btn-warning{% else %}btn-outline{% endif %}">
            ‚ö†Ô∏è –ù–∏–∑—å–∫–∏–π –∑–∞–ª–∏—à–æ–∫
        </a>
        
        <a href="{{ url_for('admin_warehouse_replenishment_new') }}" class="btn btn-success">
            ‚ûï –ó–∞–º–æ–≤–∏—Ç–∏ –ø–æ–ø–æ–≤–Ω–µ–Ω–Ω—è
        </a>
    </div>

    <!-- –¢–∞–±–ª–∏—Ü—è —Ç–æ–≤–∞—Ä—ñ–≤ -->
    <div class="table-responsive">
        <table class="admin-table">
            <thead>
                <tr>
                    <th>–¢–æ–≤–∞—Ä</th>
                    <th>SKU</th>
                    <th>–ó–∞–ª–∏—à–æ–∫</th>
                    <th>–ú—ñ–Ω. –∑–∞–ª–∏—à–æ–∫</th>
                    <th>–°—Ç–∞—Ç—É—Å</th>
                    <th>–î—ñ—ó</th>
                </tr>
            </thead>
            <tbody>
                {% for product in products %}
                <tr class="{% if product.stock == 0 %}out-of-stock{% elif product.min_stock > 0 and product.stock <= product.min_stock %}low-stock{% endif %}">
                    <td>
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            {% if product.image_url %}
                            <img src="{{ product.image_url }}" alt="" style="width: 40px; height: 40px; object-fit: cover; border-radius: 4px;">
                            {% endif %}
                            <div>
                                <strong>{{ product.name }}</strong>
                                {% if product.category %}
                                <br><small class="text-muted">{{ product.category.name }}</small>
                                {% endif %}
                            </div>
                        </div>
                    </td>
                    <td><code>{{ product.sku or '‚Äî' }}</code></td>
                    <td>
                        <span class="stock-value {% if product.stock == 0 %}zero{% elif product.min_stock > 0 and product.stock <= product.min_stock %}low{% endif %}">
                            {{ product.stock }}
                        </span>
                    </td>
                    <td>{{ product.min_stock or '‚Äî' }}</td>
                    <td>
                        {% if product.stock == 0 %}
                        <span class="badge badge-danger">‚ùå –ù–µ–º–∞—î</span>
                        {% elif product.min_stock > 0 and product.stock <= product.min_stock %}
                        <span class="badge badge-warning">‚ö†Ô∏è –ó–∞–∫—ñ–Ω—á—É—î—Ç—å—Å—è</span>
                        {% else %}
                        <span class="badge badge-success">‚úì –í –Ω–∞—è–≤–Ω–æ—Å—Ç—ñ</span>
                        {% endif %}
                    </td>
                    <td>
                        <div style="display: flex; gap: 0.25rem;">
                            <button type="button" class="btn btn-sm btn-primary" 
                                    onclick="openAdjustModal({{ product.id }}, '{{ product.name }}', {{ product.stock }})">
                                ¬±
                            </button>
                            <a href="{{ url_for('admin_warehouse_stock_history', product_id=product.id) }}" 
                               class="btn btn-sm btn-outline" title="–Ü—Å—Ç–æ—Ä—ñ—è">
                                üìú
                            </a>
                        </div>
                    </td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="6" class="text-center text-muted">
                        <p style="padding: 2rem;">
                            üì≠ –¢–æ–≤–∞—Ä—ñ–≤ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ
                        </p>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- –ü–∞–≥—ñ–Ω–∞—Ü—ñ—è -->
    {% if total_pages > 1 %}
    <div class="pagination" style="margin-top: 1.5rem; display: flex; justify-content: center; gap: 0.5rem;">
        {% if page > 1 %}
        <a href="{{ url_for('admin_warehouse_stock', page=page-1, low=show_low|int, search=search) }}" class="btn btn-sm btn-outline">‚Üê –ù–∞–∑–∞–¥</a>
        {% endif %}
        
        <span class="btn btn-sm disabled">{{ page }} –∑ {{ total_pages }}</span>
        
        {% if page < total_pages %}
        <a href="{{ url_for('admin_warehouse_stock', page=page+1, low=show_low|int, search=search) }}" class="btn btn-sm btn-outline">–î–∞–ª—ñ ‚Üí</a>
        {% endif %}
    </div>
    {% endif %}
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–µ –≤—ñ–∫–Ω–æ –∫–æ—Ä–∏–≥—É–≤–∞–Ω–Ω—è -->
<div id="adjustModal" class="modal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3>¬± –ö–æ—Ä–∏–≥—É–≤–∞–Ω–Ω—è –∑–∞–ª–∏—à–∫—É</h3>
            <button type="button" class="close" onclick="closeAdjustModal()">&times;</button>
        </div>
        <form id="adjustForm" method="POST">
            <div class="modal-body">
                <p><strong id="productName"></strong></p>
                <p>–ü–æ—Ç–æ—á–Ω–∏–π –∑–∞–ª–∏—à–æ–∫: <strong id="currentStock"></strong> —à—Ç.</p>
                
                <div class="form-group">
                    <label>–ö–æ—Ä–∏–≥—É–≤–∞–Ω–Ω—è (+/-):</label>
                    <input type="number" name="adjustment" id="adjustment" class="form-control" 
                           placeholder="-5 –∞–±–æ +10" required>
                    <small class="text-muted">–í–≤–µ–¥—ñ—Ç—å –≤—ñ–¥'—î–º–Ω–µ —á–∏—Å–ª–æ –¥–ª—è –∑–º–µ–Ω—à–µ–Ω–Ω—è, –¥–æ–¥–∞—Ç–Ω–µ –¥–ª—è –∑–±—ñ–ª—å—à–µ–Ω–Ω—è</small>
                </div>
                
                <div class="form-group">
                    <label>–ü—Ä–∏—á–∏–Ω–∞:</label>
                    <select name="reason" class="form-control">
                        <option value="inventory">–Ü–Ω–≤–µ–Ω—Ç–∞—Ä–∏–∑–∞—Ü—ñ—è</option>
                        <option value="damage">–ü–æ—à–∫–æ–¥–∂–µ–Ω–Ω—è</option>
                        <option value="return">–ü–æ–≤–µ—Ä–Ω–µ–Ω–Ω—è</option>
                        <option value="correction">–ö–æ—Ä–∏–≥—É–≤–∞–Ω–Ω—è –ø–æ–º–∏–ª–∫–∏</option>
                        <option value="other">–Ü–Ω—à–µ</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>–ü—Ä–∏–º—ñ—Ç–∫–∞:</label>
                    <textarea name="notes" class="form-control" rows="2" placeholder="–û–ø—Ü—ñ–æ–Ω–∞–ª—å–Ω–æ..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline" onclick="closeAdjustModal()">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
                <button type="submit" class="btn btn-primary">–ó–±–µ—Ä–µ–≥—Ç–∏</button>
            </div>
        </form>
    </div>
</div>

<style>
.stat-card {
    background: white;
    border-radius: 12px;
    padding: 1.5rem;
    display: flex;
    align-items: center;
    gap: 1rem;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}
.stat-card .stat-icon { font-size: 2rem; }
.stat-card .stat-value { display: block; font-size: 2rem; font-weight: bold; }
.stat-card .stat-label { color: #666; }
.stat-card.warning { border-left: 4px solid #ffc107; }
.stat-card.danger { border-left: 4px solid #dc3545; }
.stat-card.info { border-left: 4px solid #17a2b8; }

.out-of-stock { background: rgba(220, 53, 69, 0.05); }
.low-stock { background: rgba(255, 193, 7, 0.1); }

.stock-value { font-weight: bold; font-size: 1.2rem; }
.stock-value.zero { color: #dc3545; }
.stock-value.low { color: #ffc107; }

.modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.5);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
}
.modal-content {
    background: white;
    border-radius: 12px;
    width: 100%;
    max-width: 500px;
    max-height: 90vh;
    overflow-y: auto;
}
.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1rem 1.5rem;
    border-bottom: 1px solid #eee;
}
.modal-header h3 { margin: 0; }
.modal-header .close {
    background: none;
    border: none;
    font-size: 1.5rem;
    cursor: pointer;
    color: #666;
}
.modal-body { padding: 1.5rem; }
.modal-footer {
    padding: 1rem 1.5rem;
    border-top: 1px solid #eee;
    display: flex;
    justify-content: flex-end;
    gap: 0.5rem;
}

.form-group { margin-bottom: 1rem; }
.form-group label { display: block; margin-bottom: 0.25rem; font-weight: 500; }
.form-control { width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px; }

.badge { padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; font-weight: 500; }
.badge-success { background: #28a745; color: white; }
.badge-warning { background: #ffc107; color: #333; }
.badge-danger { background: #dc3545; color: white; }

.btn-outline { background: transparent; border: 1px solid #ddd; color: #333; }
.btn-outline:hover { background: #f5f5f5; }
</style>

<script>
function openAdjustModal(productId, productName, currentStock) {
    document.getElementById('adjustModal').style.display = 'flex';
    document.getElementById('productName').textContent = productName;
    document.getElementById('currentStock').textContent = currentStock;
    document.getElementById('adjustForm').action = '/admin/warehouse/stock/' + productId + '/adjust';
    document.getElementById('adjustment').value = '';
    document.getElementById('adjustment').focus();
}

function closeAdjustModal() {
    document.getElementById('adjustModal').style.display = 'none';
}

// –ó–∞–∫—Ä–∏—Ç–∏ –º–æ–¥–∞–ª—å–Ω–µ –≤—ñ–∫–Ω–æ –ø—Ä–∏ –∫–ª—ñ–∫—É –ø–æ–∑–∞ –Ω–∏–º
document.getElementById('adjustModal').addEventListener('click', function(e) {
    if (e.target === this) {
        closeAdjustModal();
    }
});
</script>
{% endblock %}
