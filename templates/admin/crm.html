{% extends "admin/layout.html" %}

{% block title %}CRM - –ü–∞—Ä—Ç–Ω–µ—Ä–∏{% endblock %}

{% block content %}
<div class="crm-page">
    <!-- Alerts Banner -->
    {% if critical_alerts %}
    <div class="alerts-banner critical">
        <div class="alert-icon">‚ö†Ô∏è</div>
        <div class="alert-content">
            <strong>{{ critical_alerts|length }} –∫—Ä–∏—Ç–∏—á–Ω–∏—Ö –∞–ª–µ—Ä—Ç—ñ–≤!</strong>
            <a href="{{ url_for('admin_crm_alerts') }}">–ü–µ—Ä–µ–≥–ª—è–Ω—É—Ç–∏</a>
        </div>
    </div>
    {% endif %}
    
    <div class="page-header">
        <h1>üè¢ CRM - –£–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è –ø–∞—Ä—Ç–Ω–µ—Ä–∞–º–∏</h1>
        <div class="header-actions">
            <a href="{{ url_for('admin_crm_alerts') }}" class="btn btn-warning">
                üîî –ê–ª–µ—Ä—Ç–∏ {% if unread_alerts_count %}<span class="badge">{{ unread_alerts_count }}</span>{% endif %}
            </a>
            <button class="btn btn-primary" onclick="runDailyCheck()">
                üîÑ –ó–∞–ø—É—Å—Ç–∏—Ç–∏ –ø–µ—Ä–µ–≤—ñ—Ä–∫—É
            </button>
        </div>
    </div>
    
    <!-- Stats Cards -->
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-icon">üë•</div>
            <div class="stat-value">{{ stats.total }}</div>
            <div class="stat-label">–í—Å—å–æ–≥–æ –ø–∞—Ä—Ç–Ω–µ—Ä—ñ–≤</div>
        </div>
        <div class="stat-card success">
            <div class="stat-icon">‚úÖ</div>
            <div class="stat-value">{{ stats.verified }}</div>
            <div class="stat-label">–í–µ—Ä–∏—Ñ—ñ–∫–æ–≤–∞–Ω—ñ</div>
        </div>
        <div class="stat-card warning">
            <div class="stat-icon">‚è≥</div>
            <div class="stat-value">{{ stats.pending }}</div>
            <div class="stat-label">–û—á—ñ–∫—É—é—Ç—å –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏</div>
        </div>
        <div class="stat-card danger">
            <div class="stat-icon">‚ùå</div>
            <div class="stat-value">{{ stats.rejected }}</div>
            <div class="stat-label">–í—ñ–¥—Ö–∏–ª–µ–Ω—ñ</div>
        </div>
    </div>
    
    <!-- Reliability Distribution -->
    <div class="reliability-chart">
        <h3>–ù–∞–¥—ñ–π–Ω—ñ—Å—Ç—å –ø–∞—Ä—Ç–Ω–µ—Ä—ñ–≤</h3>
        <div class="reliability-bars">
            <div class="bar-item high">
                <div class="bar" style="width: {{ stats.high_reliability_pct }}%"></div>
                <span class="label">–í–∏—Å–æ–∫–∞ ({{ stats.high_reliability }})</span>
            </div>
            <div class="bar-item medium">
                <div class="bar" style="width: {{ stats.medium_reliability_pct }}%"></div>
                <span class="label">–°–µ—Ä–µ–¥–Ω—è ({{ stats.medium_reliability }})</span>
            </div>
            <div class="bar-item low">
                <div class="bar" style="width: {{ stats.low_reliability_pct }}%"></div>
                <span class="label">–ù–∏–∑—å–∫–∞ ({{ stats.low_reliability }})</span>
            </div>
            <div class="bar-item critical">
                <div class="bar" style="width: {{ stats.critical_reliability_pct }}%"></div>
                <span class="label">–ö—Ä–∏—Ç–∏—á–Ω–∞ ({{ stats.critical_reliability }})</span>
            </div>
        </div>
    </div>
    
    <!-- Filters -->
    <div class="filters-panel">
        <form method="get" class="filters-form">
            <div class="filter-group">
                <label>–°—Ç–∞—Ç—É—Å</label>
                <select name="status">
                    <option value="">–í—Å—ñ</option>
                    <option value="pending" {% if filter_status == 'pending' %}selected{% endif %}>–û—á—ñ–∫—É—î</option>
                    <option value="verified" {% if filter_status == 'verified' %}selected{% endif %}>–í–µ—Ä–∏—Ñ—ñ–∫–æ–≤–∞–Ω–∏–π</option>
                    <option value="rejected" {% if filter_status == 'rejected' %}selected{% endif %}>–í—ñ–¥—Ö–∏–ª–µ–Ω–∏–π</option>
                    <option value="suspended" {% if filter_status == 'suspended' %}selected{% endif %}>–ü—Ä–∏–∑—É–ø–∏–Ω–µ–Ω–∏–π</option>
                </select>
            </div>
            <div class="filter-group">
                <label>–ù–∞–¥—ñ–π–Ω—ñ—Å—Ç—å</label>
                <select name="reliability">
                    <option value="">–í—Å—ñ</option>
                    <option value="high" {% if filter_reliability == 'high' %}selected{% endif %}>–í–∏—Å–æ–∫–∞ (80-100)</option>
                    <option value="medium" {% if filter_reliability == 'medium' %}selected{% endif %}>–°–µ—Ä–µ–¥–Ω—è (50-79)</option>
                    <option value="low" {% if filter_reliability == 'low' %}selected{% endif %}>–ù–∏–∑—å–∫–∞ (20-49)</option>
                    <option value="critical" {% if filter_reliability == 'critical' %}selected{% endif %}>–ö—Ä–∏—Ç–∏—á–Ω–∞ (0-19)</option>
                </select>
            </div>
            <div class="filter-group">
                <label>–ö—Ä–∞—ó–Ω–∞</label>
                <select name="country">
                    <option value="">–í—Å—ñ</option>
                    {% for code, name in countries %}
                    <option value="{{ code }}" {% if filter_country == code %}selected{% endif %}>{{ name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="filter-group">
                <label>–ü–æ—à—É–∫</label>
                <input type="text" name="search" value="{{ search }}" placeholder="–ù–∞–∑–≤–∞, VAT, –¥–æ–º–µ–Ω...">
            </div>
            <button type="submit" class="btn">–§—ñ–ª—å—Ç—Ä—É–≤–∞—Ç–∏</button>
            <a href="{{ url_for('admin_crm') }}" class="btn btn-secondary">–°–∫–∏–Ω—É—Ç–∏</a>
        </form>
    </div>
    
    <!-- Partners Table -->
    <div class="partners-table">
        <table>
            <thead>
                <tr>
                    <th>–ö–æ–º–ø–∞–Ω—ñ—è</th>
                    <th>VAT</th>
                    <th>–ö—Ä–∞—ó–Ω–∞</th>
                    <th>–í–µ—Ä–∏—Ñ—ñ–∫–∞—Ü—ñ—è</th>
                    <th>–ù–∞–¥—ñ–π–Ω—ñ—Å—Ç—å</th>
                    <th>–°—Ç–∞—Ç—É—Å</th>
                    <th>–û—Å—Ç–∞–Ω–Ω—è –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞</th>
                    <th>–î—ñ—ó</th>
                </tr>
            </thead>
            <tbody>
                {% for company in companies %}
                <tr class="{% if company.has_alerts %}has-alert{% endif %}">
                    <td>
                        <div class="company-info">
                            <strong>{{ company.name }}</strong>
                            {% if company.website %}
                            <a href="{{ company.website }}" target="_blank" class="domain">{{ company.domain }}</a>
                            {% endif %}
                        </div>
                    </td>
                    <td>
                        {% if company.vat_number %}
                        <code>{{ company.full_vat_number }}</code>
                        {% if company.vat_verified %}
                        <span class="check-mark">‚úì</span>
                        {% endif %}
                        {% else %}
                        <span class="na">-</span>
                        {% endif %}
                    </td>
                    <td>
                        {% if company.country_code %}
                        <span class="country-flag">{{ company.country_code }}</span>
                        {{ company.country or company.country_code }}
                        {% else %}
                        <span class="na">-</span>
                        {% endif %}
                    </td>
                    <td>
                        <div class="verification-status">
                            <span class="check-item {% if company.vat_verified %}passed{% else %}pending{% endif %}" title="VAT">
                                V{% if company.vat_verified %}‚úì{% else %}?{% endif %}
                            </span>
                            <span class="check-item {% if company.is_whois_verified %}passed{% else %}pending{% endif %}" title="WHOIS">
                                W{% if company.is_whois_verified %}‚úì{% else %}?{% endif %}
                            </span>
                            {% if company.country_code == 'DE' %}
                            <span class="check-item {% if company.is_hr_verified %}passed{% else %}pending{% endif %}" title="Handelsregister">
                                H{% if company.is_hr_verified %}‚úì{% else %}?{% endif %}
                            </span>
                            {% endif %}
                        </div>
                    </td>
                    <td>
                        <div class="reliability-score {{ company.reliability_level }}">
                            <div class="score-bar">
                                <div class="fill" style="width: {{ company.reliability_score }}%"></div>
                            </div>
                            <span class="score-value">{{ company.reliability_score }}%</span>
                        </div>
                    </td>
                    <td>
                        <span class="status-badge {{ company.status }}">
                            {% if company.status == 'verified' %}‚úÖ –í–µ—Ä–∏—Ñ—ñ–∫–æ–≤–∞–Ω–∏–π
                            {% elif company.status == 'pending' %}‚è≥ –û—á—ñ–∫—É—î
                            {% elif company.status == 'rejected' %}‚ùå –í—ñ–¥—Ö–∏–ª–µ–Ω–æ
                            {% elif company.status == 'suspended' %}üö´ –ü—Ä–∏–∑—É–ø–∏–Ω–µ–Ω–æ
                            {% endif %}
                        </span>
                    </td>
                    <td>
                        {% if company.last_verification_at %}
                        <span class="date" title="{{ company.last_verification_at }}">
                            {{ company.last_verification_at.strftime('%d.%m.%Y') }}
                        </span>
                        {% else %}
                        <span class="na">–ù—ñ–∫–æ–ª–∏</span>
                        {% endif %}
                    </td>
                    <td>
                        <div class="actions">
                            <a href="{{ url_for('admin_crm_partner', id=company.id) }}" class="btn btn-sm" title="–î–µ—Ç–∞–ª—ñ">
                                üëÅÔ∏è
                            </a>
                            <button class="btn btn-sm btn-primary" onclick="verifyPartner({{ company.id }})" title="–ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏">
                                üîç
                            </button>
                            {% if company.status == 'pending' %}
                            <button class="btn btn-sm btn-success" onclick="approvePartner({{ company.id }})" title="–ü—ñ–¥—Ç–≤–µ—Ä–¥–∏—Ç–∏">
                                ‚úÖ
                            </button>
                            <button class="btn btn-sm btn-danger" onclick="rejectPartner({{ company.id }})" title="–í—ñ–¥—Ö–∏–ª–∏—Ç–∏">
                                ‚ùå
                            </button>
                            {% endif %}
                        </div>
                    </td>
                </tr>
                {% endfor %}
                {% if not companies %}
                <tr>
                    <td colspan="8" class="empty-state">
                        –ü–∞—Ä—Ç–Ω–µ—Ä—ñ–≤ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ
                    </td>
                </tr>
                {% endif %}
            </tbody>
        </table>
    </div>
    
    <!-- Pagination -->
    {% if total_pages > 1 %}
    <div class="pagination">
        {% if page > 1 %}
        <a href="?page={{ page - 1 }}&status={{ filter_status }}&reliability={{ filter_reliability }}&country={{ filter_country }}&search={{ search }}" class="btn">‚Üê –ù–∞–∑–∞–¥</a>
        {% endif %}
        <span class="page-info">–°—Ç–æ—Ä—ñ–Ω–∫–∞ {{ page }} –∑ {{ total_pages }}</span>
        {% if page < total_pages %}
        <a href="?page={{ page + 1 }}&status={{ filter_status }}&reliability={{ filter_reliability }}&country={{ filter_country }}&search={{ search }}" class="btn">–í–ø–µ—Ä–µ–¥ ‚Üí</a>
        {% endif %}
    </div>
    {% endif %}
</div>

<style>
.crm-page { padding: 20px; }

.alerts-banner {
    display: flex;
    align-items: center;
    gap: 15px;
    padding: 15px 20px;
    border-radius: 8px;
    margin-bottom: 20px;
}
.alerts-banner.critical {
    background: linear-gradient(135deg, #ff416c, #ff4b2b);
    color: white;
}
.alerts-banner a { color: white; font-weight: bold; }

.page-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 30px;
}
.header-actions { display: flex; gap: 10px; }
.badge {
    background: #ff4444;
    color: white;
    border-radius: 50%;
    padding: 2px 8px;
    font-size: 12px;
    margin-left: 5px;
}

.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
}
.stat-card {
    background: white;
    border-radius: 12px;
    padding: 20px;
    text-align: center;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}
.stat-card.success { border-left: 4px solid #28a745; }
.stat-card.warning { border-left: 4px solid #ffc107; }
.stat-card.danger { border-left: 4px solid #dc3545; }
.stat-icon { font-size: 32px; margin-bottom: 10px; }
.stat-value { font-size: 36px; font-weight: bold; color: #333; }
.stat-label { color: #666; margin-top: 5px; }

.reliability-chart {
    background: white;
    border-radius: 12px;
    padding: 20px;
    margin-bottom: 30px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}
.reliability-chart h3 { margin-bottom: 20px; }
.reliability-bars { display: flex; flex-direction: column; gap: 10px; }
.bar-item {
    display: flex;
    align-items: center;
    gap: 15px;
}
.bar-item .bar {
    height: 24px;
    border-radius: 4px;
    min-width: 5px;
}
.bar-item.high .bar { background: linear-gradient(90deg, #28a745, #20c997); }
.bar-item.medium .bar { background: linear-gradient(90deg, #ffc107, #fd7e14); }
.bar-item.low .bar { background: linear-gradient(90deg, #fd7e14, #dc3545); }
.bar-item.critical .bar { background: linear-gradient(90deg, #dc3545, #721c24); }
.bar-item .label { min-width: 150px; color: #666; }

.filters-panel {
    background: white;
    border-radius: 12px;
    padding: 20px;
    margin-bottom: 20px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}
.filters-form {
    display: flex;
    flex-wrap: wrap;
    gap: 15px;
    align-items: end;
}
.filter-group {
    display: flex;
    flex-direction: column;
    gap: 5px;
}
.filter-group label { font-size: 12px; color: #666; font-weight: 500; }
.filter-group select, .filter-group input {
    padding: 8px 12px;
    border: 1px solid #ddd;
    border-radius: 6px;
    min-width: 150px;
}

.partners-table {
    background: white;
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}
.partners-table table { width: 100%; border-collapse: collapse; }
.partners-table th {
    background: #f8f9fa;
    padding: 12px 15px;
    text-align: left;
    font-weight: 600;
    color: #333;
    border-bottom: 2px solid #dee2e6;
}
.partners-table td {
    padding: 12px 15px;
    border-bottom: 1px solid #eee;
    vertical-align: middle;
}
.partners-table tr:hover { background: #f8f9fa; }
.partners-table tr.has-alert { background: #fff3cd; }

.company-info strong { display: block; }
.company-info .domain { font-size: 12px; color: #6c757d; }

.check-mark { color: #28a745; margin-left: 5px; }
.na { color: #aaa; }

.verification-status {
    display: flex;
    gap: 5px;
}
.check-item {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 28px;
    height: 28px;
    border-radius: 4px;
    font-size: 11px;
    font-weight: bold;
}
.check-item.passed { background: #d4edda; color: #155724; }
.check-item.pending { background: #fff3cd; color: #856404; }
.check-item.failed { background: #f8d7da; color: #721c24; }

.reliability-score {
    display: flex;
    align-items: center;
    gap: 10px;
}
.score-bar {
    width: 60px;
    height: 8px;
    background: #e9ecef;
    border-radius: 4px;
    overflow: hidden;
}
.reliability-score.high .fill { background: #28a745; }
.reliability-score.medium .fill { background: #ffc107; }
.reliability-score.low .fill { background: #fd7e14; }
.reliability-score.critical .fill { background: #dc3545; }
.score-value { font-weight: bold; font-size: 14px; }

.status-badge {
    display: inline-block;
    padding: 4px 12px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 500;
}
.status-badge.verified { background: #d4edda; color: #155724; }
.status-badge.pending { background: #fff3cd; color: #856404; }
.status-badge.rejected { background: #f8d7da; color: #721c24; }
.status-badge.suspended { background: #e2e3e5; color: #383d41; }

.actions { display: flex; gap: 5px; }
.btn-sm { padding: 5px 10px; font-size: 14px; }

.empty-state {
    text-align: center;
    padding: 40px;
    color: #999;
}

.pagination {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 20px;
    margin-top: 20px;
}
.page-info { color: #666; }

/* Buttons */
.btn {
    display: inline-flex;
    align-items: center;
    gap: 5px;
    padding: 10px 16px;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-size: 14px;
    text-decoration: none;
    background: #e9ecef;
    color: #333;
}
.btn:hover { background: #dee2e6; }
.btn-primary { background: #007bff; color: white; }
.btn-primary:hover { background: #0056b3; }
.btn-success { background: #28a745; color: white; }
.btn-success:hover { background: #1e7e34; }
.btn-danger { background: #dc3545; color: white; }
.btn-danger:hover { background: #c82333; }
.btn-warning { background: #ffc107; color: #333; }
.btn-warning:hover { background: #e0a800; }
.btn-secondary { background: #6c757d; color: white; }
</style>

<script>
function verifyPartner(id) {
    if (!confirm('–ó–∞–ø—É—Å—Ç–∏—Ç–∏ –ø–µ—Ä–µ–≤—ñ—Ä–∫—É –ø–∞—Ä—Ç–Ω–µ—Ä–∞?')) return;
    
    fetch(`/admin/crm/partner/${id}/verify`, { method: 'POST' })
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                alert('–ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞: ' + data.summary);
                location.reload();
            } else {
                alert('–ü–æ–º–∏–ª–∫–∞: ' + data.error);
            }
        });
}

function approvePartner(id) {
    if (!confirm('–ü—ñ–¥—Ç–≤–µ—Ä–¥–∏—Ç–∏ –ø–∞—Ä—Ç–Ω–µ—Ä–∞?')) return;
    
    fetch(`/admin/crm/partner/${id}/approve`, { method: 'POST' })
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                alert('–ü–∞—Ä—Ç–Ω–µ—Ä –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–∏–π!');
                location.reload();
            } else {
                alert('–ü–æ–º–∏–ª–∫–∞: ' + data.error);
            }
        });
}

function rejectPartner(id) {
    const reason = prompt('–ü—Ä–∏—á–∏–Ω–∞ –≤—ñ–¥–º–æ–≤–∏:');
    if (reason === null) return;
    
    fetch(`/admin/crm/partner/${id}/reject`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ reason })
    })
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                alert('–ü–∞—Ä—Ç–Ω–µ—Ä –≤—ñ–¥—Ö–∏–ª–µ–Ω–∏–π');
                location.reload();
            } else {
                alert('–ü–æ–º–∏–ª–∫–∞: ' + data.error);
            }
        });
}

function runDailyCheck() {
    if (!confirm('–ó–∞–ø—É—Å—Ç–∏—Ç–∏ –ø–µ—Ä–µ–≤—ñ—Ä–∫—É –≤—Å—ñ—Ö –ø–∞—Ä—Ç–Ω–µ—Ä—ñ–≤? –¶–µ –º–æ–∂–µ –∑–∞–π–Ω—è—Ç–∏ –¥–µ—è–∫–∏–π —á–∞—Å.')) return;
    
    fetch('/admin/crm/run-daily-check', { method: 'POST' })
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                alert(`–ü–µ—Ä–µ–≤—ñ—Ä–µ–Ω–æ: ${data.checked} –ø–∞—Ä—Ç–Ω–µ—Ä—ñ–≤. –ê–ª–µ—Ä—Ç—ñ–≤: ${data.alerts}`);
                location.reload();
            } else {
                alert('–ü–æ–º–∏–ª–∫–∞: ' + data.error);
            }
        });
}
</script>
{% endblock %}
