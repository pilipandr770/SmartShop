{% extends 'admin/layout.html' %}
{% block title %}–†–µ–¥–∞–≥—É–≤–∞—Ç–∏ —Ç–æ–≤–∞—Ä - –ê–¥–º—ñ–Ω –ø–∞–Ω–µ–ª—å{% endblock %}
{% block content %}
<div class="page-header" style="display: flex; justify-content: space-between; align-items: center;">
    <div>
        <h1>‚úèÔ∏è –†–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è —Ç–æ–≤–∞—Ä—É</h1>
        <p class="page-subtitle">{{ product.name }}</p>
    </div>
    <a href="{{ url_for('admin_products') }}" class="btn btn-secondary">‚Üê –ù–∞–∑–∞–¥ –¥–æ —Å–ø–∏—Å–∫—É</a>
</div>

<form method="post">
    <div class="card" style="margin-bottom: 2rem;">
        <div class="card-header">
            <h3>üì¶ –û—Å–Ω–æ–≤–Ω–∞ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è</h3>
        </div>
        <div class="form-section">
            <div class="form-row three-col">
                <div class="form-group">
                    <label for="name">–ù–∞–∑–≤–∞ —Ç–æ–≤–∞—Ä—É *</label>
                    <input type="text" id="name" name="name" value="{{ product.name }}" required>
                </div>
                <div class="form-group">
                    <label for="price">–¶—ñ–Ω–∞ *</label>
                    <input type="number" id="price" name="price" value="{{ product.price }}" step="0.01" min="0" required>
                </div>
                <div class="form-group">
                    <label for="old_price">–°—Ç–∞—Ä–∞ —Ü—ñ–Ω–∞</label>
                    <input type="number" id="old_price" name="old_price" value="{{ product.old_price or '' }}" step="0.01" min="0" placeholder="–î–ª—è –∑–Ω–∏–∂–∫–∏">
                </div>
            </div>
            
            <div class="form-row three-col">
                <div class="form-group">
                    <label for="category_id">–ö–∞—Ç–µ–≥–æ—Ä—ñ—è</label>
                    <select id="category_id" name="category_id">
                        <option value="">(–±–µ–∑ –∫–∞—Ç–µ–≥–æ—Ä—ñ—ó)</option>
                        {% for c in categories %}
                            <option value="{{ c.id }}" {% if product.category_id == c.id %}selected{% endif %}>
                                {{ c.name }}
                            </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-group">
                    <label for="sku">SKU / –ê—Ä—Ç–∏–∫—É–ª</label>
                    <input type="text" id="sku" name="sku" value="{{ product.sku or '' }}" placeholder="ABC-123">
                </div>
                <div class="form-group">
                    <label for="stock">–ö—ñ–ª—å–∫—ñ—Å—Ç—å –Ω–∞ —Å–∫–ª–∞–¥—ñ</label>
                    <input type="number" id="stock" name="stock" value="{{ product.stock or 0 }}" min="0">
                </div>
            </div>
        </div>
    </div>

    <div class="card" style="margin-bottom: 2rem;">
        <div class="card-header">
            <h3>üñºÔ∏è –ó–æ–±—Ä–∞–∂–µ–Ω–Ω—è</h3>
        </div>
        <div class="form-section">
            <div class="image-upload-wrapper">
                <div class="image-preview-box" id="imagePreview">
                    {% if product.image_url %}
                    <img src="{{ product.image_url }}" alt="{{ product.name }}">
                    {% else %}
                    <span class="preview-placeholder">üì∑ –ù–µ–º–∞—î –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è</span>
                    {% endif %}
                </div>
                <div class="upload-controls">
                    <div class="upload-btn-wrapper">
                        <button type="button" class="btn btn-secondary" onclick="document.getElementById('imageFile').click()">
                            üì§ –ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –∑ –∫–æ–º–ø'—é—Ç–µ—Ä–∞
                        </button>
                        <input type="file" id="imageFile" accept="image/*" style="display: none;" onchange="uploadImage(this)">
                    </div>
                    <span class="upload-or">–∞–±–æ</span>
                    <input type="url" id="image_url" name="image_url" value="{{ product.image_url or '' }}" placeholder="–í—Å—Ç–∞–≤—Ç–µ URL –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è" class="url-input">
                </div>
                <div id="uploadStatus" class="upload-status"></div>
            </div>
        </div>
    </div>

    <div class="card" style="margin-bottom: 2rem;">
        <div class="card-header">
            <h3>üìù –û–ø–∏—Å–∏</h3>
        </div>
        <div class="form-section">
            <div class="form-group">
                <label for="short_description">–ö–æ—Ä–æ—Ç–∫–∏–π –æ–ø–∏—Å</label>
                <textarea id="short_description" name="short_description" rows="3" placeholder="–ö–æ—Ä–æ—Ç–∫–∏–π –æ–ø–∏—Å –¥–ª—è –∫–∞—Ç–∞–ª–æ–≥—É...">{{ product.short_description or '' }}</textarea>
            </div>
            
            <div class="form-group">
                <label for="long_description">–ü–æ–≤–Ω–∏–π –æ–ø–∏—Å</label>
                <textarea id="long_description" name="long_description" rows="6" placeholder="–î–µ—Ç–∞–ª—å–Ω–∏–π –æ–ø–∏—Å —Ç–æ–≤–∞—Ä—É...">{{ product.long_description or '' }}</textarea>
            </div>
        </div>
    </div>

    <div class="card" style="margin-bottom: 2rem;">
        <div class="card-header">
            <h3>‚öôÔ∏è –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è</h3>
        </div>
        <div class="form-section">
            <label class="checkbox-label">
                <input type="checkbox" name="is_active" {% if product.is_active %}checked{% endif %}>
                <span>–¢–æ–≤–∞—Ä –∞–∫—Ç–∏–≤–Ω–∏–π (–ø–æ–∫–∞–∑—É–≤–∞—Ç–∏ –Ω–∞ —Å–∞–π—Ç—ñ)</span>
            </label>
        </div>
    </div>

    <div class="form-footer">
        <a href="{{ url_for('admin_products') }}" class="btn btn-secondary">–°–∫–∞—Å—É–≤–∞—Ç–∏</a>
        <button type="submit" class="btn btn-primary btn-lg">üíæ –ó–±–µ—Ä–µ–≥—Ç–∏ –∑–º—ñ–Ω–∏</button>
    </div>
</form>

<!-- –ù–µ–±–µ–∑–ø–µ—á–Ω–∞ –∑–æ–Ω–∞ -->
<div class="card danger-zone" style="margin-top: 2rem;">
    <div class="card-header">
        <h3>‚ö†Ô∏è –ù–µ–±–µ–∑–ø–µ—á–Ω–∞ –∑–æ–Ω–∞</h3>
    </div>
    <div class="form-section">
        <p class="text-muted">–í–∏–¥–∞–ª–µ–Ω–Ω—è —Ç–æ–≤–∞—Ä—É —î –Ω–µ–∑–≤–æ—Ä–æ—Ç–Ω–æ—é –¥—ñ—î—é.</p>
        <form method="post" action="{{ url_for('admin_products_delete', product_id=product.id) }}" onsubmit="return confirm('–í–∏ –≤–ø–µ–≤–Ω–µ–Ω—ñ, —â–æ —Ö–æ—á–µ—Ç–µ –≤–∏–¥–∞–ª–∏—Ç–∏ —Ü–µ–π —Ç–æ–≤–∞—Ä?');">
            <button type="submit" class="btn btn-danger">üóëÔ∏è –í–∏–¥–∞–ª–∏—Ç–∏ —Ç–æ–≤–∞—Ä</button>
        </form>
    </div>
</div>

<style>
.form-section {
    padding: 1.5rem;
}

.form-row {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 1.5rem;
    margin-bottom: 1.25rem;
}

.form-row.three-col {
    grid-template-columns: repeat(3, 1fr);
}

.form-row:last-child {
    margin-bottom: 0;
}

.form-group {
    margin-bottom: 1.25rem;
}

.form-group:last-child {
    margin-bottom: 0;
}

.checkbox-label {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    cursor: pointer;
}

.checkbox-label input[type="checkbox"] {
    width: 20px;
    height: 20px;
    accent-color: var(--primary-color);
}

.image-preview {
    margin-top: 1rem;
}

.image-preview label {
    display: block;
    margin-bottom: 0.5rem;
    color: var(--text-secondary);
}

.image-preview img {
    max-width: 300px;
    border-radius: var(--radius);
    border: 2px solid var(--border-color);
}

.form-footer {
    display: flex;
    justify-content: flex-end;
    gap: 1rem;
    padding: 1rem 0;
}

.btn-lg {
    padding: 1rem 2rem;
    font-size: 1.05rem;
}

.danger-zone {
    border-color: var(--danger-color);
}

.danger-zone .card-header h3 {
    color: var(--danger-color);
}

.danger-zone .text-muted {
    margin-bottom: 1rem;
}

@media (max-width: 900px) {
    .form-row,
    .form-row.three-col {
        grid-template-columns: 1fr;
    }
}

/* Image Upload Styles */
.image-upload-wrapper {
    display: flex;
    flex-direction: column;
    gap: 1rem;
}

.image-preview-box {
    width: 250px;
    height: 250px;
    border: 2px dashed var(--border-color);
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    overflow: hidden;
    background: var(--bg-tertiary);
}

.image-preview-box img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.preview-placeholder {
    color: var(--text-secondary);
    font-size: 1rem;
}

.upload-controls {
    display: flex;
    align-items: center;
    gap: 1rem;
    flex-wrap: wrap;
}

.upload-or {
    color: var(--text-secondary);
    font-size: 0.85rem;
}

.url-input {
    flex: 1;
    min-width: 250px;
}

.upload-status {
    font-size: 0.85rem;
}

.upload-status.success {
    color: var(--success-color);
}

.upload-status.error {
    color: var(--danger-color);
}

.upload-status.loading {
    color: var(--primary-color);
}
</style>

<script>
async function uploadImage(input) {
    if (!input.files || !input.files[0]) return;
    
    const file = input.files[0];
    const statusEl = document.getElementById('uploadStatus');
    const previewEl = document.getElementById('imagePreview');
    const urlInput = document.getElementById('image_url');
    
    // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —Ä–æ–∑–º—ñ—Ä—É (max 16MB)
    if (file.size > 16 * 1024 * 1024) {
        statusEl.textContent = '‚ùå –§–∞–π–ª –∑–∞–Ω–∞–¥—Ç–æ –≤–µ–ª–∏–∫–∏–π (–º–∞–∫—Å. 16 –ú–ë)';
        statusEl.className = 'upload-status error';
        return;
    }
    
    statusEl.textContent = '‚è≥ –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...';
    statusEl.className = 'upload-status loading';
    
    const formData = new FormData();
    formData.append('file', file);
    
    try {
        const response = await fetch('/admin/upload', {
            method: 'POST',
            body: formData
        });
        
        const data = await response.json();
        
        if (data.success) {
            // –ü–æ–∫–∞–∑—É—î–º–æ –ø—Ä–µ–≤ º—é
            previewEl.innerHTML = `<img src="${data.url}" alt="Preview">`;
            
            // –ó–±–µ—Ä—ñ–≥–∞—î–º–æ URL
            urlInput.value = data.url;
            
            statusEl.textContent = '‚úÖ –ó–æ–±—Ä–∞–∂–µ–Ω–Ω—è –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ!';
            statusEl.className = 'upload-status success';
        } else {
            statusEl.textContent = '‚ùå ' + (data.error || '–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è');
            statusEl.className = 'upload-status error';
        }
    } catch (error) {
        statusEl.textContent = '‚ùå –ü–æ–º–∏–ª–∫–∞ –∑\'—î–¥–Ω–∞–Ω–Ω—è';
        statusEl.className = 'upload-status error';
    }
}

// –û–Ω–æ–≤–ª–µ–Ω–Ω—è –ø—Ä–µ–≤ º—é –ø—Ä–∏ –≤–≤–æ–¥—ñ URL
document.getElementById('image_url').addEventListener('input', function() {
    const url = this.value.trim();
    const previewEl = document.getElementById('imagePreview');
    
    if (url) {
        previewEl.innerHTML = `<img src="${url}" alt="Preview" onerror="this.parentElement.innerHTML='<span class=\\'preview-placeholder\\'>‚ùå –ù–µ–≤—ñ—Ä–Ω–∏–π URL</span>'">`;
    } else {
        previewEl.innerHTML = '<span class="preview-placeholder">üì∑ –ù–µ–º–∞—î –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è</span>';
    }
});
</script>
{% endblock %}
