{% extends "base.html" %}

{% block title %}B2B –†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è - {{ settings.site_name or 'SmartShop' }}{% endblock %}

{% block content %}
<div class="auth-container">
    <div class="auth-card auth-card-wide">
        <div class="auth-header">
            <h1>üè¢ B2B –ü–∞—Ä—Ç–Ω–µ—Ä—Å—Ç–≤–æ</h1>
            <p>–†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è –¥–ª—è –±—ñ–∑–Ω–µ—Å-–∫–ª—ñ—î–Ω—Ç—ñ–≤</p>
        </div>
        
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                <div class="alert alert-{{ category }}">{{ message }}</div>
                {% endfor %}
            {% endif %}
        {% endwith %}
        
        <form method="POST" class="auth-form" id="b2bForm">
            <!-- –°–µ–∫—Ü—ñ—è: –î–∞–Ω—ñ –∫–æ–º–ø–∞–Ω—ñ—ó -->
            <div class="form-section">
                <h3>üìã –î–∞–Ω—ñ –∫–æ–º–ø–∞–Ω—ñ—ó</h3>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="company_name">–ù–∞–∑–≤–∞ –∫–æ–º–ø–∞–Ω—ñ—ó *</label>
                        <input type="text" id="company_name" name="company_name" required 
                               placeholder="–¢–û–í ¬´–í–∞—à–∞ –ö–æ–º–ø–∞–Ω—ñ—è¬ª" value="{{ request.form.get('company_name', '') }}">
                    </div>
                    
                    <div class="form-group">
                        <label for="legal_name">–Æ—Ä–∏–¥–∏—á–Ω–∞ –Ω–∞–∑–≤–∞</label>
                        <input type="text" id="legal_name" name="legal_name" 
                               placeholder="–ü–æ–≤–Ω–∞ —é—Ä–∏–¥–∏—á–Ω–∞ –Ω–∞–∑–≤–∞" value="{{ request.form.get('legal_name', '') }}">
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="vat_country">–ö—Ä–∞—ó–Ω–∞ VAT</label>
                        <select id="vat_country" name="vat_country">
                            <option value="">–û–±–µ—Ä—ñ—Ç—å –∫—Ä–∞—ó–Ω—É</option>
                            <option value="DE" {% if request.form.get('vat_country') == 'DE' %}selected{% endif %}>üá©üá™ –ù—ñ–º–µ—á—á–∏–Ω–∞ (DE)</option>
                            <option value="AT" {% if request.form.get('vat_country') == 'AT' %}selected{% endif %}>üá¶üáπ –ê–≤—Å—Ç—Ä—ñ—è (AT)</option>
                            <option value="PL" {% if request.form.get('vat_country') == 'PL' %}selected{% endif %}>üáµüá± –ü–æ–ª—å—â–∞ (PL)</option>
                            <option value="CZ" {% if request.form.get('vat_country') == 'CZ' %}selected{% endif %}>üá®üáø –ß–µ—Ö—ñ—è (CZ)</option>
                            <option value="FR" {% if request.form.get('vat_country') == 'FR' %}selected{% endif %}>üá´üá∑ –§—Ä–∞–Ω—Ü—ñ—è (FR)</option>
                            <option value="IT" {% if request.form.get('vat_country') == 'IT' %}selected{% endif %}>üáÆüáπ –Ü—Ç–∞–ª—ñ—è (IT)</option>
                            <option value="ES" {% if request.form.get('vat_country') == 'ES' %}selected{% endif %}>üá™üá∏ –Ü—Å–ø–∞–Ω—ñ—è (ES)</option>
                            <option value="NL" {% if request.form.get('vat_country') == 'NL' %}selected{% endif %}>üá≥üá± –ù—ñ–¥–µ—Ä–ª–∞–Ω–¥–∏ (NL)</option>
                            <option value="BE" {% if request.form.get('vat_country') == 'BE' %}selected{% endif %}>üáßüá™ –ë–µ–ª—å–≥—ñ—è (BE)</option>
                            <option value="SE" {% if request.form.get('vat_country') == 'SE' %}selected{% endif %}>üá∏üá™ –®–≤–µ—Ü—ñ—è (SE)</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="vat_number">VAT –Ω–æ–º–µ—Ä (–ü–î–í)</label>
                        <div class="input-with-btn">
                            <input type="text" id="vat_number" name="vat_number" 
                                   placeholder="123456789" value="{{ request.form.get('vat_number', '') }}">
                            <button type="button" class="btn btn-sm btn-check" onclick="checkVAT()">
                                –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏
                            </button>
                        </div>
                        <div id="vatStatus" class="vat-status"></div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="website">–í–µ–±-—Å–∞–π—Ç</label>
                    <input type="url" id="website" name="website" 
                           placeholder="https://your-company.com" value="{{ request.form.get('website', '') }}">
                </div>
            </div>
            
            <!-- –°–µ–∫—Ü—ñ—è: –ê–¥—Ä–µ—Å–∞ -->
            <div class="form-section">
                <h3>üìç –ê–¥—Ä–µ—Å–∞</h3>
                
                <div class="form-group">
                    <label for="address">–ê–¥—Ä–µ—Å–∞</label>
                    <input type="text" id="address" name="address" 
                           placeholder="–≤—É–ª. –ì–æ–ª–æ–≤–Ω–∞, 1" value="{{ request.form.get('address', '') }}">
                </div>
                
                <div class="form-row three-col">
                    <div class="form-group">
                        <label for="city">–ú—ñ—Å—Ç–æ</label>
                        <input type="text" id="city" name="city" 
                               placeholder="–ö–∏—ó–≤" value="{{ request.form.get('city', '') }}">
                    </div>
                    
                    <div class="form-group">
                        <label for="postal_code">–ü–æ—à—Ç–æ–≤–∏–π —ñ–Ω–¥–µ–∫—Å</label>
                        <input type="text" id="postal_code" name="postal_code" 
                               placeholder="01001" value="{{ request.form.get('postal_code', '') }}">
                    </div>
                    
                    <div class="form-group">
                        <label for="country">–ö—Ä–∞—ó–Ω–∞</label>
                        <input type="text" id="country" name="country" 
                               placeholder="–£–∫—Ä–∞—ó–Ω–∞" value="{{ request.form.get('country', '') }}">
                    </div>
                </div>
            </div>
            
            <!-- –°–µ–∫—Ü—ñ—è: –ö–æ–Ω—Ç–∞–∫—Ç–Ω–∞ –æ—Å–æ–±–∞ -->
            <div class="form-section">
                <h3>üë§ –ö–æ–Ω—Ç–∞–∫—Ç–Ω–∞ –æ—Å–æ–±–∞</h3>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="first_name">–Ü–º'—è *</label>
                        <input type="text" id="first_name" name="first_name" required 
                               placeholder="–Ü–≤–∞–Ω" value="{{ request.form.get('first_name', '') }}">
                    </div>
                    
                    <div class="form-group">
                        <label for="last_name">–ü—Ä—ñ–∑–≤–∏—â–µ *</label>
                        <input type="text" id="last_name" name="last_name" required 
                               placeholder="–ü–µ—Ç—Ä–µ–Ω–∫–æ" value="{{ request.form.get('last_name', '') }}">
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="email">Email *</label>
                        <input type="email" id="email" name="email" required 
                               placeholder="business@company.com" value="{{ request.form.get('email', '') }}">
                    </div>
                    
                    <div class="form-group">
                        <label for="phone">–¢–µ–ª–µ—Ñ–æ–Ω</label>
                        <input type="tel" id="phone" name="phone" 
                               placeholder="+380 XX XXX XX XX" value="{{ request.form.get('phone', '') }}">
                    </div>
                </div>
            </div>
            
            <!-- –°–µ–∫—Ü—ñ—è: –ü–∞—Ä–æ–ª—å -->
            <div class="form-section">
                <h3>üîê –ë–µ–∑–ø–µ–∫–∞</h3>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="password">–ü–∞—Ä–æ–ª—å *</label>
                        <input type="password" id="password" name="password" required 
                               placeholder="–ú—ñ–Ω. 8 —Å–∏–º–≤–æ–ª—ñ–≤">
                    </div>
                    
                    <div class="form-group">
                        <label for="password_confirm">–ü—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è *</label>
                        <input type="password" id="password_confirm" name="password_confirm" required 
                               placeholder="–ü–æ–≤—Ç–æ—Ä—ñ—Ç—å –ø–∞—Ä–æ–ª—å">
                    </div>
                </div>
            </div>
            
            <div class="form-info">
                <p>‚ÑπÔ∏è –ü—ñ—Å–ª—è —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó –≤–∞—à–∞ –∑–∞—è–≤–∫–∞ –±—É–¥–µ —Ä–æ–∑–≥–ª—è–Ω—É—Ç–∞. –ú–∏ –ø–µ—Ä–µ–≤—ñ—Ä–∏–º–æ –¥–∞–Ω—ñ –∫–æ–º–ø–∞–Ω—ñ—ó —Ç–∞ –ø–æ–≤—ñ–¥–æ–º–∏–º–æ –ø—Ä–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç –Ω–∞ –≤–∫–∞–∑–∞–Ω–∏–π email.</p>
            </div>
            
            <button type="submit" class="btn btn-primary btn-block btn-lg">
                üöÄ –ü–æ–¥–∞—Ç–∏ –∑–∞—è–≤–∫—É –Ω–∞ –ø–∞—Ä—Ç–Ω–µ—Ä—Å—Ç–≤–æ
            </button>
        </form>
        
        <div class="auth-footer">
            <p>–í–∂–µ —î –∞–∫–∞—É–Ω—Ç? <a href="{{ url_for('user_login') }}">–£–≤—ñ–π—Ç–∏</a></p>
            <p>–ü—Ä–∏–≤–∞—Ç–Ω–∏–π –ø–æ–∫—É–ø–µ—Ü—å? <a href="{{ url_for('user_register') }}">–ó–≤–∏—á–∞–π–Ω–∞ —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—è</a></p>
        </div>
    </div>
</div>

<style>
.auth-container {
    min-height: 80vh;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 2rem;
}

.auth-card {
    background: var(--card-bg, #1e293b);
    border-radius: 1rem;
    padding: 2.5rem;
    width: 100%;
    max-width: 480px;
    box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
    border: 1px solid rgba(148, 163, 184, 0.1);
}

.auth-card-wide {
    max-width: 680px;
}

.auth-header {
    text-align: center;
    margin-bottom: 2rem;
}

.auth-header h1 {
    font-size: 1.75rem;
    margin-bottom: 0.5rem;
    color: var(--text-primary, #f1f5f9);
}

.auth-header p {
    color: var(--text-secondary, #94a3b8);
}

.form-section {
    margin-bottom: 2rem;
    padding-bottom: 1.5rem;
    border-bottom: 1px solid rgba(148, 163, 184, 0.1);
}

.form-section:last-of-type {
    border-bottom: none;
}

.form-section h3 {
    font-size: 1.1rem;
    margin-bottom: 1rem;
    color: var(--text-primary, #f1f5f9);
}

.form-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1rem;
}

.form-row.three-col {
    grid-template-columns: repeat(3, 1fr);
}

.auth-form .form-group {
    margin-bottom: 1rem;
}

.auth-form label {
    display: block;
    margin-bottom: 0.5rem;
    font-weight: 500;
    color: var(--text-primary, #f1f5f9);
    font-size: 0.9rem;
}

.auth-form input,
.auth-form select {
    width: 100%;
    padding: 0.75rem 1rem;
    border: 1px solid rgba(148, 163, 184, 0.3);
    border-radius: 0.5rem;
    background: rgba(15, 23, 42, 0.8);
    color: var(--text-primary, #f1f5f9);
    font-size: 0.95rem;
    transition: all 0.2s;
}

.auth-form input:focus,
.auth-form select:focus {
    outline: none;
    border-color: var(--primary-color, #10b981);
    box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
}

.input-with-btn {
    display: flex;
    gap: 0.5rem;
}

.input-with-btn input {
    flex: 1;
}

.btn-sm {
    padding: 0.5rem 1rem;
    font-size: 0.85rem;
    white-space: nowrap;
}

.btn-check {
    background: rgba(59, 130, 246, 0.2);
    border: 1px solid rgba(59, 130, 246, 0.5);
    color: #93c5fd;
    border-radius: 0.5rem;
    cursor: pointer;
    transition: all 0.2s;
}

.btn-check:hover {
    background: rgba(59, 130, 246, 0.3);
}

.vat-status {
    margin-top: 0.5rem;
    font-size: 0.85rem;
    min-height: 1.2rem;
}

.vat-status.valid {
    color: #6ee7b7;
}

.vat-status.invalid {
    color: #fca5a5;
}

.vat-status.checking {
    color: #93c5fd;
}

.form-info {
    background: rgba(59, 130, 246, 0.1);
    border: 1px solid rgba(59, 130, 246, 0.3);
    border-radius: 0.5rem;
    padding: 1rem;
    margin-bottom: 1.5rem;
    font-size: 0.9rem;
    color: #93c5fd;
}

.btn-block {
    width: 100%;
    padding: 1rem;
    font-size: 1rem;
}

.btn-lg {
    padding: 1.125rem 1.5rem;
    font-size: 1.05rem;
}

.btn-primary {
    background: linear-gradient(135deg, #3b82f6, #2563eb);
    border: none;
    color: white;
    font-weight: 600;
    border-radius: 0.5rem;
    cursor: pointer;
    transition: all 0.2s;
}

.btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 10px 20px rgba(59, 130, 246, 0.3);
}

.auth-footer {
    margin-top: 2rem;
    text-align: center;
    padding-top: 1.5rem;
    border-top: 1px solid rgba(148, 163, 184, 0.1);
}

.auth-footer p {
    color: var(--text-secondary, #94a3b8);
    margin-bottom: 0.5rem;
}

.auth-footer a {
    color: var(--primary-color, #10b981);
    text-decoration: none;
}

.auth-footer a:hover {
    text-decoration: underline;
}

.alert {
    padding: 0.875rem 1rem;
    border-radius: 0.5rem;
    margin-bottom: 1rem;
    font-size: 0.9rem;
}

.alert-danger {
    background: rgba(239, 68, 68, 0.15);
    border: 1px solid rgba(239, 68, 68, 0.3);
    color: #fca5a5;
}

.alert-success {
    background: rgba(16, 185, 129, 0.15);
    border: 1px solid rgba(16, 185, 129, 0.3);
    color: #6ee7b7;
}

.alert-warning {
    background: rgba(245, 158, 11, 0.15);
    border: 1px solid rgba(245, 158, 11, 0.3);
    color: #fcd34d;
}

.alert-info {
    background: rgba(59, 130, 246, 0.15);
    border: 1px solid rgba(59, 130, 246, 0.3);
    color: #93c5fd;
}

@media (max-width: 640px) {
    .form-row,
    .form-row.three-col {
        grid-template-columns: 1fr;
    }
    
    .auth-card {
        padding: 1.5rem;
    }
}
</style>

<script>
async function checkVAT() {
    const vatNumber = document.getElementById('vat_number').value.trim();
    const vatCountry = document.getElementById('vat_country').value;
    const statusEl = document.getElementById('vatStatus');
    
    if (!vatNumber) {
        statusEl.textContent = '‚ùå –í–≤–µ–¥—ñ—Ç—å VAT –Ω–æ–º–µ—Ä';
        statusEl.className = 'vat-status invalid';
        return;
    }
    
    statusEl.textContent = '‚è≥ –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞...';
    statusEl.className = 'vat-status checking';
    
    try {
        const formData = new FormData();
        formData.append('vat_number', vatNumber);
        if (vatCountry) formData.append('vat_country', vatCountry);
        
        const response = await fetch('/auth/check-vat', {
            method: 'POST',
            body: formData
        });
        
        const data = await response.json();
        
        if (data.valid) {
            statusEl.innerHTML = `‚úÖ –ü—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–æ: <strong>${data.name || 'OK'}</strong>`;
            statusEl.className = 'vat-status valid';
            
            // –ê–≤—Ç–æ–∑–∞–ø–æ–≤–Ω–µ–Ω–Ω—è –¥–∞–Ω–∏—Ö
            if (data.name && !document.getElementById('legal_name').value) {
                document.getElementById('legal_name').value = data.name;
            }
            if (data.address && !document.getElementById('address').value) {
                document.getElementById('address').value = data.address;
            }
        } else {
            statusEl.textContent = `‚ùå ${data.error || 'VAT –Ω–æ–º–µ—Ä –Ω–µ–¥—ñ–π—Å–Ω–∏–π'}`;
            statusEl.className = 'vat-status invalid';
        }
    } catch (error) {
        statusEl.textContent = '‚ùå –ü–æ–º–∏–ª–∫–∞ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏';
        statusEl.className = 'vat-status invalid';
    }
}
</script>
{% endblock %}
