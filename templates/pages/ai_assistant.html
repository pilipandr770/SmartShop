{% extends 'base.html' %}
{% block title %}–Ü–Ü-–ø—Ä–æ–¥–∞–≤–µ—Ü—å ‚Äì SmartShop AI{% endblock %}

{% block extra_styles %}
<style>
    .ai-hero {
        text-align: center;
        padding: 3rem 1rem;
        background: radial-gradient(circle at center, rgba(34, 197, 94, 0.15), transparent 70%);
        border-radius: 1.5rem;
        margin-bottom: 2rem;
    }

    .ai-hero h1 {
        font-size: 2.5rem;
        margin-bottom: 1rem;
        background: linear-gradient(120deg, #22c55e, #14b8a6, #a855f7);
        -webkit-background-clip: text;
        background-clip: text;
        color: transparent;
    }

    .ai-hero p {
        font-size: 1.1rem;
        color: var(--text-muted);
        max-width: 600px;
        margin: 0 auto;
    }

    .ai-chat-container {
        display: grid;
        grid-template-columns: 1fr 350px;
        gap: 2rem;
        min-height: 500px;
    }

    .ai-chat-main {
        display: flex;
        flex-direction: column;
        border-radius: 1rem;
        border: 1px solid rgba(148, 163, 184, 0.45);
        background: rgba(15, 23, 42, 0.9);
        overflow: hidden;
    }

    .ai-chat-header {
        padding: 1rem 1.5rem;
        background: rgba(34, 197, 94, 0.1);
        border-bottom: 1px solid rgba(148, 163, 184, 0.25);
        display: flex;
        align-items: center;
        gap: 1rem;
    }

    .ai-avatar {
        width: 48px;
        height: 48px;
        border-radius: 50%;
        background: linear-gradient(135deg, #22c55e, #14b8a6);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
    }

    .ai-info h3 {
        margin: 0;
        font-size: 1.1rem;
    }

    .ai-info .status {
        font-size: 0.8rem;
        color: #22c55e;
    }

    .ai-messages {
        flex: 1;
        padding: 1.5rem;
        overflow-y: auto;
        display: flex;
        flex-direction: column;
        gap: 1rem;
        min-height: 350px;
        max-height: 450px;
    }

    .ai-message {
        display: flex;
        gap: 0.75rem;
        max-width: 85%;
    }

    .ai-message.bot {
        align-self: flex-start;
    }

    .ai-message.user {
        align-self: flex-end;
        flex-direction: row-reverse;
    }

    .ai-message .avatar {
        width: 36px;
        height: 36px;
        border-radius: 50%;
        background: linear-gradient(135deg, #22c55e, #14b8a6);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1rem;
        flex-shrink: 0;
    }

    .ai-message.user .avatar {
        background: linear-gradient(135deg, #a855f7, #06b6d4);
    }

    .ai-message .content {
        padding: 0.85rem 1.1rem;
        border-radius: 1rem;
        font-size: 0.9rem;
        line-height: 1.5;
    }

    .ai-message.bot .content {
        background: rgba(30, 41, 59, 0.9);
        border: 1px solid rgba(148, 163, 184, 0.3);
        border-bottom-left-radius: 0.25rem;
    }

    .ai-message.user .content {
        background: rgba(34, 197, 94, 0.15);
        border: 1px solid rgba(34, 197, 94, 0.4);
        border-bottom-right-radius: 0.25rem;
    }

    .ai-input-area {
        padding: 1rem 1.5rem;
        border-top: 1px solid rgba(148, 163, 184, 0.25);
        display: flex;
        gap: 0.75rem;
    }

    .ai-input-area input {
        flex: 1;
        padding: 0.85rem 1.25rem;
        border-radius: 999px;
        border: 1px solid rgba(148, 163, 184, 0.45);
        background: rgba(15, 23, 42, 0.8);
        color: var(--text-main);
        font-size: 0.9rem;
    }

    .ai-input-area input:focus {
        outline: none;
        border-color: var(--accent);
    }

    .ai-input-area button {
        padding: 0.85rem 1.5rem;
        border-radius: 999px;
        border: none;
        background: linear-gradient(135deg, #22c55e, #14b8a6);
        color: #022c22;
        font-weight: 600;
        cursor: pointer;
        transition: transform 0.2s, box-shadow 0.2s;
    }

    .ai-input-area button:hover {
        transform: scale(1.02);
        box-shadow: 0 8px 20px rgba(16, 185, 129, 0.4);
    }

    /* Sidebar */
    .ai-sidebar {
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }

    .ai-sidebar-card {
        padding: 1.25rem;
        border-radius: 1rem;
        border: 1px solid rgba(148, 163, 184, 0.45);
        background: rgba(15, 23, 42, 0.9);
    }

    .ai-sidebar-card h4 {
        margin: 0 0 0.75rem;
        font-size: 0.95rem;
        color: var(--text-muted);
    }

    .quick-questions {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
    }

    .quick-question {
        padding: 0.6rem 0.85rem;
        border-radius: 0.5rem;
        border: 1px solid rgba(148, 163, 184, 0.35);
        background: rgba(15, 23, 42, 0.8);
        font-size: 0.8rem;
        color: var(--text-muted);
        cursor: pointer;
        transition: all 0.2s;
        text-align: left;
    }

    .quick-question:hover {
        border-color: var(--accent);
        color: var(--text-main);
    }

    .catalog-preview {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
        max-height: 200px;
        overflow-y: auto;
    }

    .catalog-item {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.5rem;
        border-radius: 0.5rem;
        background: rgba(15, 23, 42, 0.6);
        font-size: 0.8rem;
    }

    .catalog-item img {
        width: 32px;
        height: 32px;
        border-radius: 0.25rem;
        object-fit: cover;
    }

    .catalog-item .name {
        flex: 1;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .catalog-item .price {
        color: #bbf7d0;
        font-weight: 600;
    }

    .ai-features {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 1rem;
        margin-top: 2rem;
    }

    .ai-feature {
        text-align: center;
        padding: 1.5rem 1rem;
        border-radius: 1rem;
        border: 1px solid rgba(148, 163, 184, 0.35);
        background: rgba(15, 23, 42, 0.6);
    }

    .ai-feature .icon {
        font-size: 2rem;
        margin-bottom: 0.75rem;
    }

    .ai-feature h4 {
        margin: 0 0 0.5rem;
        font-size: 0.95rem;
    }

    .ai-feature p {
        font-size: 0.8rem;
        color: var(--text-muted);
        margin: 0;
    }

    @media (max-width: 920px) {
        .ai-chat-container {
            grid-template-columns: 1fr;
        }

        .ai-sidebar {
            display: none;
        }

        .ai-features {
            grid-template-columns: 1fr;
        }
    }
</style>
{% endblock %}

{% block content %}
<section>
    <div class="breadcrumb">
        <a href="{{ url_for('index') }}">{{ _('–ì–æ–ª–æ–≤–Ω–∞') }}</a>
        <span>/</span>
        <span style="color: var(--text-main);">{{ _('–Ü–Ü-–ø—Ä–æ–¥–∞–≤–µ—Ü—å') }}</span>
    </div>

    <div class="ai-hero">
        <h1>ü§ñ {{ _('–Ü–Ü-–ø—Ä–æ–¥–∞–≤–µ—Ü—å') }}</h1>
        <p>{{ _('–í–∞—à –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–∏–π –ø–æ–º—ñ—á–Ω–∏–∫, —è–∫–∏–π –∑–Ω–∞—î –≤–µ—Å—å –∫–∞—Ç–∞–ª–æ–≥ —Ç–∞ –≥–æ—Ç–æ–≤–∏–π –¥–æ–ø–æ–º–æ–≥—Ç–∏ 24/7') }}</p>
    </div>

    <div class="ai-chat-container">
        <div class="ai-chat-main">
            <div class="ai-chat-header">
                <div class="ai-avatar">ü§ñ</div>
                <div class="ai-info">
                    <h3>SmartShop AI Assistant</h3>
                    <div class="status">‚óè {{ _('–û–Ω–ª–∞–π–Ω') }}</div>
                </div>
            </div>

            <div class="ai-messages" id="aiMessagesMain">
                <div class="ai-message bot">
                    <div class="avatar">ü§ñ</div>
                    <div class="content">
                        {{ _('–í—ñ—Ç–∞—é!') }} üëã {{ _('–Ø –Ü–Ü-–ø–æ–º—ñ—á–Ω–∏–∫ –º–∞–≥–∞–∑–∏–Ω—É SmartShop. –ú–æ–∂—É –¥–æ–ø–æ–º–æ–≥—Ç–∏ –≤–∞–º:') }}<br><br>
                        ‚Ä¢ {{ _('–ó–Ω–∞–π—Ç–∏ –ø–æ—Ç—Ä—ñ–±–Ω–∏–π —Ç–æ–≤–∞—Ä') }}<br>
                        ‚Ä¢ {{ _('–ü–æ—Ä—ñ–≤–Ω—è—Ç–∏ –ø—Ä–æ–¥—É–∫—Ç–∏') }}<br>
                        ‚Ä¢ {{ _('–í—ñ–¥–ø–æ–≤—ñ—Å—Ç–∏ –Ω–∞ –ø–∏—Ç–∞–Ω–Ω—è –ø—Ä–æ –¥–æ—Å—Ç–∞–≤–∫—É') }}<br>
                        ‚Ä¢ {{ _('–ü—ñ–¥—ñ–±—Ä–∞—Ç–∏ —Ç–æ–≤–∞—Ä –∑–∞ –±—é–¥–∂–µ—Ç–æ–º') }}<br><br>
                        {{ _('–©–æ –≤–∞—Å —Ü—ñ–∫–∞–≤–∏—Ç—å?') }}
                    </div>
                </div>
            </div>

            <div class="ai-input-area">
                <input type="text" id="aiInputMain" placeholder="{{ _('–ù–∞–ø–∏—à—ñ—Ç—å –≤–∞—à–µ –∑–∞–ø–∏—Ç–∞–Ω–Ω—è...') }}" onkeypress="if(event.key==='Enter')sendMainMessage()">
                <button onclick="sendMainMessage()">{{ _('–ù–∞–¥—ñ—Å–ª–∞—Ç–∏') }} ‚û§</button>
            </div>
        </div>

        <div class="ai-sidebar">
            <div class="ai-sidebar-card">
                <h4>üí° {{ _('–®–≤–∏–¥–∫—ñ –∑–∞–ø–∏—Ç–∞–Ω–Ω—è') }}</h4>
                <div class="quick-questions">
                    <button class="quick-question" onclick="askQuestion('{{ _('–Ø–∫—ñ —Ç–æ–≤–∞—Ä–∏ —î –≤ –Ω–∞—è–≤–Ω–æ—Å—Ç—ñ?') }}')">
                        {{ _('–Ø–∫—ñ —Ç–æ–≤–∞—Ä–∏ —î –≤ –Ω–∞—è–≤–Ω–æ—Å—Ç—ñ?') }}
                    </button>
                    <button class="quick-question" onclick="askQuestion('{{ _('–°–∫—ñ–ª—å–∫–∏ –∫–æ—à—Ç—É—î –¥–æ—Å—Ç–∞–≤–∫–∞?') }}')">
                        {{ _('–°–∫—ñ–ª—å–∫–∏ –∫–æ—à—Ç—É—î –¥–æ—Å—Ç–∞–≤–∫–∞?') }}
                    </button>
                    <button class="quick-question" onclick="askQuestion('{{ _('–ü–æ—Ä–µ–∫–æ–º–µ–Ω–¥—É–π —â–æ—Å—å –¥–æ 100‚Ç¨') }}')">
                        {{ _('–ü–æ—Ä–µ–∫–æ–º–µ–Ω–¥—É–π —â–æ—Å—å –¥–æ 100‚Ç¨') }}
                    </button>
                    <button class="quick-question" onclick="askQuestion('{{ _('–Ø–∫ –æ—Ñ–æ—Ä–º–∏—Ç–∏ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è?') }}')">
                        {{ _('–Ø–∫ –æ—Ñ–æ—Ä–º–∏—Ç–∏ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è?') }}
                    </button>
                </div>
            </div>

            <div class="ai-sidebar-card">
                <h4>üì¶ {{ _('–ö–∞—Ç–∞–ª–æ–≥') }} ({{ products|length }} {{ _('—Ç–æ–≤–∞—Ä—ñ–≤') }})</h4>
                <div class="catalog-preview">
                    {% for p in products[:5] %}
                    <a href="{{ url_for('product_page', product_id=p.id) }}" class="catalog-item">
                        <img src="{{ p.image_url or 'https://images.pexels.com/photos/3965545/pexels-photo-3965545.jpeg?auto=compress&cs=tinysrgb&w=100' }}" alt="{{ p.get_name(get_locale()|string) }}">
                        <span class="name">{{ p.get_name(get_locale()|string) }}</span>
                        <span class="price">{{ "%.0f"|format(p.price) }}‚Ç¨</span>
                    </a>
                    {% else %}
                    <p style="font-size: 0.8rem; color: var(--text-muted);">{{ _('–¢–æ–≤–∞—Ä–∏ —â–µ –Ω–µ –¥–æ–¥–∞–Ω—ñ') }}</p>
                    {% endfor %}
                </div>
                {% if products|length > 5 %}
                <a href="{{ url_for('shop') }}" style="display: block; text-align: center; margin-top: 0.75rem; font-size: 0.8rem; color: var(--accent);">
                    {{ _('–ü–µ—Ä–µ–≥–ª—è–Ω—É—Ç–∏ –≤—Å—ñ') }} ‚Üí
                </a>
                {% endif %}
            </div>

            <div class="ai-sidebar-card">
                <h4>‚öôÔ∏è –Ü–Ω—Å—Ç—Ä—É–∫—Ü—ñ—ó –Ü–Ü</h4>
                <p style="font-size: 0.75rem; color: var(--text-muted); margin: 0;">
                    {{ (settings.ai_instructions or '–Ü–Ü-–ø—Ä–æ–¥–∞–≤–µ—Ü—å –Ω–∞–ª–∞—à—Ç–æ–≤–∞–Ω–∏–π –±—É—Ç–∏ –≤–≤—ñ—á–ª–∏–≤–∏–º —Ç–∞ –¥–æ–ø–æ–º–∞–≥–∞—Ç–∏ –∑ –≤–∏–±–æ—Ä–æ–º —Ç–æ–≤–∞—Ä—ñ–≤.')[:100] }}...
                </p>
                <a href="{{ url_for('admin_blocks') }}" style="display: block; margin-top: 0.5rem; font-size: 0.75rem; color: var(--accent);">
                    –ù–∞–ª–∞—à—Ç—É–≤–∞—Ç–∏ –≤ –∞–¥–º—ñ–Ω—Ü—ñ ‚Üí
                </a>
            </div>
        </div>
    </div>

    <div class="ai-features">
        <div class="ai-feature">
            <div class="icon">üß†</div>
            <h4>–ó–Ω–∞—î –∫–∞—Ç–∞–ª–æ–≥</h4>
            <p>–ë–∞—á–∏—Ç—å —É—Å—ñ —Ç–æ–≤–∞—Ä–∏, —Ü—ñ–Ω–∏ —Ç–∞ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ –≤ —Ä–µ–∞–ª—å–Ω–æ–º—É —á–∞—Å—ñ</p>
        </div>
        <div class="ai-feature">
            <div class="icon">üí¨</div>
            <h4>–ü—Ä–∏—Ä–æ–¥–Ω–∞ –º–æ–≤–∞</h4>
            <p>–†–æ–∑—É–º—ñ—î –∑–∞–ø–∏—Ç–∞–Ω–Ω—è —É–∫—Ä–∞—ó–Ω—Å—å–∫–æ—é, –∞–Ω–≥–ª—ñ–π—Å—å–∫–æ—é —Ç–∞ –Ω—ñ–º–µ—Ü—å–∫–æ—é</p>
        </div>
        <div class="ai-feature">
            <div class="icon">‚ö°</div>
            <h4>–ú–∏—Ç—Ç—î–≤—ñ –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ</h4>
            <p>–ü—Ä–∞—Ü—é—î 24/7 —ñ –≤—ñ–¥–ø–æ–≤—ñ–¥–∞—î –∑–∞ —Å–µ–∫—É–Ω–¥–∏</p>
        </div>
    </div>
</section>

<script>
async function sendMainMessage() {
    const input = document.getElementById('aiInputMain');
    const messages = document.getElementById('aiMessagesMain');
    const text = input.value.trim();
    
    if (!text) return;
    
    // Add user message
    const userDiv = document.createElement('div');
    userDiv.className = 'ai-message user';
    userDiv.innerHTML = `
        <div class="avatar">üë§</div>
        <div class="content">${text}</div>
    `;
    messages.appendChild(userDiv);
    
    input.value = '';
    messages.scrollTop = messages.scrollHeight;
    
    // Add loading
    const loadingDiv = document.createElement('div');
    loadingDiv.className = 'ai-message bot';
    loadingDiv.id = 'loadingMsgMain';
    loadingDiv.innerHTML = `
        <div class="avatar">ü§ñ</div>
        <div class="content" style="color: var(--text-muted);">–î—É–º–∞—é...</div>
    `;
    messages.appendChild(loadingDiv);
    messages.scrollTop = messages.scrollHeight;
    
    try {
        const response = await fetch('/api/chat', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({message: text})
        });
        
        const data = await response.json();
        loadingDiv.remove();
        
        const botDiv = document.createElement('div');
        botDiv.className = 'ai-message bot';
        botDiv.innerHTML = `
            <div class="avatar">ü§ñ</div>
            <div class="content">${data.message || data.error || '–í–∏–±–∞—á—Ç–µ, —Å—Ç–∞–ª–∞—Å—è –ø–æ–º–∏–ª–∫–∞.'}</div>
        `;
        messages.appendChild(botDiv);
    } catch (e) {
        loadingDiv.remove();
        const errorDiv = document.createElement('div');
        errorDiv.className = 'ai-message bot';
        errorDiv.innerHTML = `
            <div class="avatar">ü§ñ</div>
            <div class="content">–ù–µ –≤–¥–∞–ª–æ—Å—è –ø—ñ–¥–∫–ª—é—á–∏—Ç–∏—Å—è. –°–ø—Ä–æ–±—É–π—Ç–µ –ø—ñ–∑–Ω—ñ—à–µ.</div>
        `;
        messages.appendChild(errorDiv);
    }
    
    messages.scrollTop = messages.scrollHeight;
}

function askQuestion(question) {
    document.getElementById('aiInputMain').value = question;
    sendMainMessage();
}
</script>
{% endblock %}
